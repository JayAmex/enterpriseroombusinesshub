<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Enterprise Room Business Hub</title>
    <link rel="icon" type="image/jpeg" href="assets/logo.jpg">
    <link rel="stylesheet" href="css/styles.css">
    <script>
        // Check authentication before page loads
        const adminToken = sessionStorage.getItem('adminToken');
        const adminAuthenticated = sessionStorage.getItem('adminAuthenticated');
        
        if (!adminToken || adminAuthenticated !== 'true') {
            window.location.href = 'admin-login.html';
        }
    </script>
    <style>
        /* Admin-specific styles */
        .admin-container {
            display: flex;
            min-height: 100vh;
            background: linear-gradient(to bottom, #e6f2ff, #f0f8ff);
        }

        .admin-sidebar {
            width: 250px;
            background: var(--primary);
            color: var(--white);
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .admin-sidebar h2 {
            color: var(--white);
            margin-bottom: 30px;
            font-size: 1.5rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 15px;
        }

        .admin-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .admin-menu li {
            margin-bottom: 10px;
        }

        .admin-menu a {
            display: block;
            color: var(--white);
            text-decoration: none;
            padding: 12px 15px;
            border-radius: 5px;
            transition: all 0.3s;
            opacity: 0.8;
        }

        .admin-menu a:hover,
        .admin-menu a.active {
            background: rgba(255, 255, 255, 0.2);
            opacity: 1;
        }

        .admin-content {
            flex: 1;
            margin-left: 250px;
            padding: 30px;
        }

        .admin-header {
            background: var(--white);
            padding: 20px 30px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-section {
            display: none;
            background: var(--white);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .admin-section.active {
            display: block;
        }

        .admin-section h3 {
            margin-top: 0;
            color: var(--primary);
            border-bottom: 2px solid var(--light);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .content-item {
            background: #f5fbff;
            border: 1px solid #d0e8ff;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s;
        }

        .content-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .content-item h4 {
            margin-top: 0;
            color: var(--primary);
        }

        .content-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Table styles for members directory */
        .directory-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: none;
        }

        .directory-table thead {
            background: var(--primary);
            color: var(--white);
        }

        .directory-table th {
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            border: none;
        }

        .directory-table td {
            padding: 10px 8px;
            border: none;
            vertical-align: middle;
            font-size: 0.9rem;
        }

        .directory-table tbody tr {
            border-bottom: 1px solid var(--border);
        }

        .directory-table tbody tr:hover {
            background: var(--light);
        }

        .directory-table tbody tr:last-child {
            border-bottom: none;
        }

        .member-avatar-square {
            width: 50px;
            height: 50px;
            border-radius: 0;
            object-fit: cover;
            border: none;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-edit {
            background: var(--accent);
            color: var(--white);
        }

        .btn-edit:hover,
        .btn-edit.active {
            background: var(--primary);
        }

        .directory-tab-content {
            display: block;
        }

        .btn-delete {
            background: var(--live);
            color: var(--white);
        }

        .btn-delete:hover {
            background: #c53030;
        }

        .btn-add {
            background: var(--success);
            color: var(--white);
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 20px;
            display: inline-block;
        }

        .btn-add:hover {
            background: #38a169;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-full {
            grid-column: 1 / -1;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: var(--white);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h4 {
            margin: 0 0 10px 0;
            color: var(--white);
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
        }

        @media (max-width: 768px) {
            .admin-sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .admin-content {
                margin-left: 0;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<div class="admin-container">
    <aside class="admin-sidebar">
        <h2>Admin Dashboard</h2>
        <ul class="admin-menu">
            <li><a href="#" class="active" onclick="showSection('overview', this); return false;">Overview</a></li>
            <li><a href="#" onclick="showSection('users', this); return false;">Users</a></li>
            <li><a href="#" onclick="showSection('members', this); return false;">Members</a></li>
            <li><a href="#" onclick="showSection('events', this); return false;">Events</a></li>
            <li><a href="#" onclick="showSection('blog', this); return false;">Blog Posts</a></li>
            <li><a href="#" onclick="showSection('directories', this); return false;">Directories</a></li>
            <li><a href="#" onclick="showSection('homepage', this); return false;">Homepage</a></li>
            <li><a href="#" onclick="showSection('newsletter', this); return false;">Newsletter Subscribers</a></li>
            <li><a href="#" onclick="showSection('tools', this); return false;">Tools</a></li>
            <li><a href="#" onclick="showSection('templates', this); return false;">Templates</a></li>
            <li><a href="index.html" style="margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">‚Üê Back to Site</a></li>
            <li><a href="#" onclick="logout(); return false;" style="margin-top: 10px; color: #fc8181;">Logout</a></li>
        </ul>
    </aside>

    <main class="admin-content">
        <div class="admin-header">
            <h1 style="margin: 0; color: var(--primary);">Content Management</h1>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span style="color: var(--text-light);" id="welcomeMessage">Welcome, Admin</span>
                <button onclick="logout()" class="btn-small btn-delete" style="padding: 8px 15px;">Logout</button>
            </div>
        </div>

        <!-- Overview Section -->
        <div id="overview" class="admin-section active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">Dashboard Overview</h3>
                <button onclick="updateOverviewStats()" class="btn-small btn-edit" style="padding: 8px 15px;">üîÑ Refresh Stats</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Total Events</h4>
                    <p class="stat-value" id="statEvents">0</p>
                </div>
                <div class="stat-card">
                    <h4>Blog Posts</h4>
                    <p class="stat-value" id="statBlogPosts">0</p>
                </div>
                <div class="stat-card">
                    <h4>Directory Entries</h4>
                    <p class="stat-value" id="statDirectoryEntries">0</p>
                </div>
                <div class="stat-card">
                    <h4>Registered Users</h4>
                    <p class="stat-value" id="statRegisteredUsers">0</p>
                </div>
                <div class="stat-card">
                    <h4>Members</h4>
                    <p class="stat-value" id="statMembers">0</p>
                </div>
            </div>
            <div class="card">
                <h4>Quick Actions</h4>
                <p>Use the sidebar menu to manage different sections of your website content.</p>
                <ul style="line-height: 2;">
                    <li><strong>Registered Users:</strong> View, edit, and manage registered users</li>
                    <li><strong>Members:</strong> Add, edit, and manage members in the Members Directory</li>
                    <li><strong>Events:</strong> Add, edit, or remove events from the Events page</li>
                    <li><strong>Blog Posts:</strong> Manage articles, case studies, and testimonials</li>
                    <li><strong>Directories:</strong> Update business, member, and partner directories</li>
                    <li><strong>Homepage:</strong> Edit hero section, introduction, and featured content</li>
                    <li><strong>Tools:</strong> Manage financial tools and calculators</li>
                </ul>
            </div>
        </div>

        <!-- Users Section -->
        <div id="users" class="admin-section">
            <h3>Manage Users</h3>
            <p style="color: var(--text-light); margin-bottom: 20px;">View and manage all registered users on the platform.</p>
            
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <input type="text" id="userSearch" placeholder="Search users by name or email..." style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid var(--border); border-radius: 5px;" onkeyup="filterUsers()">
                <select id="userSort" onchange="sortUsers()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 5px;">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="name">Sort by Name</option>
                    <option value="email">Sort by Email</option>
                </select>
                <select id="userPageSize" onchange="changeUserPageSize()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 5px;">
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100" selected>100 per page</option>
                    <option value="200">200 per page</option>
                </select>
                <button onclick="refreshUsers()" class="btn-small btn-edit" style="padding: 8px 15px;">Refresh</button>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="directory-table" style="width: 100%; border-collapse: collapse; background: var(--white); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: none;">
                    <thead style="background: var(--primary); color: var(--white);">
                        <tr>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Name</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Email</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Phone</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">UUID</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Registered</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Status</th>
                            <th style="width: 120px; padding: 10px 8px; text-align: center; font-weight: 600; font-size: 0.9rem; border: none;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersList">
                        <!-- Users will be loaded here dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div id="noUsersMessage" style="display: none; text-align: center; padding: 40px; color: var(--text-light);">
                <p>No registered users found.</p>
            </div>
            
            <!-- Pagination Controls -->
            <div id="usersPagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; padding: 20px 0;">
                <!-- Pagination will be loaded here -->
            </div>
        </div>

        <!-- Members Section -->
        <div id="members" class="admin-section">
            <h3>Manage Members</h3>
            <p style="color: var(--text-light); margin-bottom: 20px;">View and manage members in the Members Directory.</p>
            
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <input type="text" id="memberSearch" placeholder="Search members by name..." style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid var(--border); border-radius: 5px;" onkeyup="filterMembers()">
                <select id="memberSort" onchange="sortMembers()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 5px;">
                    <option value="name">Sort by Name</option>
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                </select>
                <select id="memberPageSize" onchange="changeMemberPageSize()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 5px;">
                    <option value="10">10 per page</option>
                    <option value="30" selected>30 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                </select>
                <button onclick="refreshMembers()" class="btn-small btn-edit" style="padding: 8px 15px;">Refresh</button>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="directory-table" style="width: 100%; border-collapse: collapse; background: var(--white); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: none;">
                    <thead style="background: var(--primary); color: var(--white);">
                        <tr>
                            <th style="width: 80px; padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Avatar</th>
                            <th style="width: 15%; padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Name</th>
                            <th style="width: 15%; padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Current Title</th>
                            <th style="width: 18%; padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Current Organisation</th>
                            <th style="width: 18%; padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Personal Website</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Social Media Profiles</th>
                            <th style="width: 120px; padding: 10px 8px; text-align: center; font-weight: 600; font-size: 0.9rem; border: none;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="membersList">
                        <!-- Members will be loaded here dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div id="noMembersMessage" style="display: none; text-align: center; padding: 40px; color: var(--text-light);">
                <p>No members found.</p>
            </div>
            
            <!-- Pagination Controls -->
            <div id="membersPagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; padding: 20px 0;">
                <!-- Pagination will be loaded here -->
            </div>
        </div>


        <!-- Events Section -->
        <div id="events" class="admin-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">Manage Events</h3>
                <button class="btn-add" onclick="showEventForm()">+ Add New Event</button>
            </div>
            
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <input type="text" id="eventSearch" placeholder="Search events by title..." style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid var(--border); border-radius: 5px;" onkeyup="filterEvents()">
                <select id="eventFilter" onchange="filterEvents()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 5px;">
                    <option value="all">All Events</option>
                    <option value="featured">Featured</option>
                    <option value="live">Live Now</option>
                    <option value="upcoming">Upcoming</option>
                    <option value="historical">Historical</option>
                </select>
                <select id="eventSort" onchange="sortEvents()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 5px;">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="title">Sort by Title</option>
                    <option value="date">Sort by Date</option>
                </select>
                <select id="eventPageSize" onchange="changeEventPageSize()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 5px;">
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100" selected>100 per page</option>
                    <option value="200">200 per page</option>
                </select>
                <button onclick="refreshEvents()" class="btn-small btn-edit" style="padding: 8px 15px;">Refresh</button>
                <button onclick="bulkUpdateEventStatuses()" class="btn-small btn-edit" style="padding: 8px 15px; background: #10b981; color: white; border: none;">üîÑ Auto-Update Statuses</button>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="directory-table" style="width: 100%; border-collapse: collapse; background: var(--white); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: none;">
                    <thead style="background: var(--primary); color: var(--white);">
                        <tr>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Title</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Type</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Date</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Location</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Status</th>
                            <th style="padding: 10px 8px; text-align: center; font-weight: 600; font-size: 0.9rem; border: none;" id="rsvpHeader">RSVPs</th>
                            <th style="width: 250px; padding: 10px 8px; text-align: center; font-weight: 600; font-size: 0.9rem; border: none;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="eventsList">
                        <!-- Events will be loaded here dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div id="noEventsMessage" style="display: none; text-align: center; padding: 40px; color: var(--text-light);">
                <p>No events found.</p>
            </div>
            
            <!-- Pagination Controls -->
            <div id="eventsPagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; padding: 20px 0;">
                <!-- Pagination will be loaded here -->
            </div>

            <div id="eventForm" style="display: none; margin-top: 30px;">
                <div class="card">
                    <h4 id="eventFormTitle">Add/Edit Event</h4>
                    <form id="eventFormElement" onsubmit="saveEvent(event)">
                        <input type="hidden" id="eventId" value="">
                        <div class="form-grid">
                            <div class="input-group">
                                <label>Event Title</label>
                                <input type="text" id="eventTitle" placeholder="Event Name" required>
                            </div>
                            <div class="input-group">
                                <label>Event Date</label>
                                <input type="date" id="eventDate" required>
                            </div>
                            <div class="input-group">
                                <label>Event Time</label>
                                <input type="time" id="eventTime">
                            </div>
                            <div class="input-group">
                                <label>Event Type</label>
                                <select id="eventType" required>
                                    <option value="regular">Regular Event</option>
                                    <option value="pitch">Pitch Your Business Event</option>
                                </select>
                                <small style="color: var(--text-light); font-size: 0.85rem; margin-top: 5px; display: block;">Pitch events are displayed on the Pitch Your Business page</small>
                            </div>
                            <div class="input-group">
                                <label>Status</label>
                                <select id="eventStatus" required>
                                    <option value="Upcoming">Upcoming</option>
                                    <option value="Live Now">Live Now</option>
                                    <option value="Featured">Featured</option>
                                    <option value="Historical">Historical</option>
                                </select>
                            </div>
                            <div class="input-group form-full">
                                <label>Description</label>
                                <textarea rows="4" id="eventDescription" placeholder="Event description..." required></textarea>
                            </div>
                            <div class="input-group form-full">
                                <label>Social Media Links (JSON format)</label>
                                <textarea rows="3" id="eventSocialLinks" placeholder='{"linkedin": "https://...", "instagram": "https://...", "twitter": "https://...", "youtube": "https://..."}'></textarea>
                                <small style="color: var(--text-light); font-size: 0.85rem; margin-top: 5px; display: block;">Enter social media links as JSON. Leave empty to show default labels without links.</small>
                            </div>
                            <div class="input-group form-full">
                                <label>Event Flier/Media</label>
                                <div style="display: flex; gap: 15px; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <input type="file" id="eventFlierUpload" accept="image/*" onchange="handleEventFlierUpload(event)" style="padding: 8px; border: 1px solid var(--border); border-radius: 8px; width: 100%;">
                                        <small style="color: var(--text-light); font-size: 0.85rem; margin-top: 5px; display: block;">Upload event flier image from your device (recommended: 300x400px or larger, max 5MB)</small>
                                    </div>
                                    <div style="width: 150px; height: 200px; border: 2px solid var(--border); border-radius: 8px; overflow: hidden; background: var(--light); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <img id="eventFlierPreview" src="" alt="Flier Preview" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                        <span id="eventFlierPlaceholder" style="color: var(--text-light); font-size: 0.75rem; text-align: center; padding: 10px;">Flier Preview</span>
                                    </div>
                                </div>
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
                                    <label style="font-size: 0.9rem; color: var(--text-light);">Or use Image URL:</label>
                                    <input type="url" id="eventFlierURL" placeholder="https://... (Alternative: paste image URL)" style="margin-top: 5px;" onchange="handleEventFlierURL(event)">
                                </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="eventSaveBtn">Save Event</button>
                            <button type="button" class="btn btn-prev" onclick="hideEventForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Blog Section -->
        <div id="blog" class="admin-section">
            <h3>Manage Blog Posts</h3>
            <button class="btn-add" onclick="showBlogForm()">+ Add New Post</button>
            
            <div class="content-grid" id="blogList">
                <div class="content-item" data-blog-id="1">
                    <h4>The Future of Logistics in Nigeria</h4>
                    <p><strong>Category:</strong> News</p>
                    <p><strong>Author:</strong> Sarah Jenkins</p>
                    <p><strong>Published:</strong> Dec 15, 2025</p>
                    <div class="content-actions">
                        <button class="btn-small btn-edit" onclick="editBlog(1)">Edit</button>
                        <button class="btn-small btn-delete" onclick="deleteBlog(1)">Delete</button>
                    </div>
                </div>
                <div class="content-item" data-blog-id="2">
                    <h4>Funding Tips for Founders</h4>
                    <p><strong>Category:</strong> Strategy</p>
                    <p><strong>Author:</strong> David Chen</p>
                    <p><strong>Published:</strong> Dec 10, 2025</p>
                    <div class="content-actions">
                        <button class="btn-small btn-edit" onclick="editBlog(2)">Edit</button>
                        <button class="btn-small btn-delete" onclick="deleteBlog(2)">Delete</button>
                    </div>
                </div>
                <div class="content-item" data-blog-id="3">
                    <h4>2025 Market Impact Report</h4>
                    <p><strong>Category:</strong> Research</p>
                    <p><strong>Author:</strong> Enterprise Research Team</p>
                    <p><strong>Published:</strong> Nov 28, 2025</p>
                    <div class="content-actions">
                        <button class="btn-small btn-edit" onclick="editBlog(3)">Edit</button>
                        <button class="btn-small btn-delete" onclick="deleteBlog(3)">Delete</button>
                    </div>
                </div>
            </div>

            <div id="blogForm" style="display: none; margin-top: 30px;">
                <div class="card">
                    <h4 id="blogFormTitle">Add/Edit Blog Post</h4>
                    <form id="blogFormElement" onsubmit="saveBlog(event)">
                        <input type="hidden" id="blogId" value="">
                        <div class="form-grid">
                            <div class="input-group">
                                <label>Post Title</label>
                                <input type="text" id="blogTitle" placeholder="Post Title" required>
                            </div>
                            <div class="input-group">
                                <label>Category</label>
                                <select id="blogCategory" required>
                                    <option value="News">News</option>
                                    <option value="Strategy">Strategy</option>
                                    <option value="Research">Research</option>
                                    <option value="Case Study">Case Study</option>
                                    <option value="Testimonial">Testimonial</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Author</label>
                                <input type="text" id="blogAuthor" placeholder="Author Name" required>
                            </div>
                            <div class="input-group form-full">
                                <label>Content</label>
                                <textarea rows="8" id="blogContent" placeholder="Post content..." required></textarea>
                            </div>
                            <div class="input-group form-full">
                                <label>Featured Image</label>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <div style="border: 2px dashed var(--border); border-radius: 8px; padding: 15px; text-align: center; background: var(--light); min-height: 150px; display: flex; align-items: center; justify-content: center; position: relative;">
                                        <input type="file" id="blogImageUpload" accept="image/*" onchange="handleBlogImageUpload(event)" style="position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2;">
                                        <img id="blogImagePreview" src="" alt="Image Preview" style="max-width: 100%; max-height: 200px; object-fit: contain; display: none; border-radius: 8px;">
                                        <span id="blogImagePlaceholder" style="color: var(--text-light); font-size: 0.9rem; z-index: 1;">Click to upload image<br><span style="font-size: 0.8rem;">or use external link below</span></span>
                                    </div>
                                    <input type="url" id="blogImageURL" placeholder="Or paste image URL here (e.g., Giphy, Imgur, direct image links)" onchange="handleBlogImageURL(event)">
                                    <small style="color: var(--text-light); font-size: 0.8rem; margin-top: -5px;">Supports external links from Giphy, Imgur, or any direct image URL</small>
                                    <div id="blogImageStatus" style="font-size: 0.85rem; color: var(--text-light); display: none;"></div>
                                </div>
                            </div>
                            <div class="input-group">
                                <label>Publish Date</label>
                                <input type="date" id="blogPublishDate" required>
                            </div>
                            <div class="input-group form-full">
                                <label>Tags (comma-separated)</label>
                                <input type="text" id="blogTags" placeholder="e.g., startup, business, strategy, funding">
                                <small style="color: var(--text-light); font-size: 0.8rem; margin-top: 5px; display: block;">Separate multiple tags with commas</small>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="blogSaveBtn">Save Post</button>
                            <button type="button" class="btn btn-prev" onclick="hideBlogForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Directories Section -->
        <div id="directories" class="admin-section">
            <h3>Manage Directories</h3>
                <p style="color: var(--text-light); margin-bottom: 20px;">
                Directories are displayed in a tabular format with pagination (100 entries per page by default). Use the tabs below to switch between directory types.
                <br><strong>Note:</strong> When users register businesses through the registration form, they are automatically added to the Business Directory. All businesses can be managed here.
            </p>
            
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn-small btn-edit" id="businessTabBtn" onclick="showDirectoryTab('business')">Business Directory</button>
                <button class="btn-small btn-edit" id="membersTabBtn" onclick="showDirectoryTab('members')">Members Directory</button>
                <button class="btn-small btn-edit" id="partnersTabBtn" onclick="showDirectoryTab('partners')">Partner Directory</button>
            </div>

            <!-- Business Directory -->
            <div id="businessDir" class="directory-tab-content">
                <p style="color: var(--text-light); margin-bottom: 20px; padding: 15px; background: var(--light); border-radius: 8px;">
                    <strong>Note:</strong> This directory displays all businesses - both those registered by users and those added directly by admins. All businesses can be managed, edited, or deleted from here.
                </p>
                <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <label style="font-size: 0.9rem; color: var(--text-light);">Entries per page:</label>
                    <select id="dirBusinessPageSize" onchange="changeDirBusinessPageSize()" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px;">
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="200">200</option>
                    </select>
                </div>
                <table class="directory-table" style="width: 100%; border-collapse: collapse; background: var(--white); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: none;">
                    <thead style="background: var(--primary); color: var(--white);">
                        <tr>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Business Name</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Address</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Email</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Phone</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Website</th>
                            <th style="width: 150px; padding: 10px 8px; text-align: center; font-weight: 600; font-size: 0.9rem; border: none;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="businessList">
                        <!-- Business entries will be loaded here -->
                    </tbody>
                </table>
                <div id="noDirBusinessMessage" style="display: none; text-align: center; padding: 40px; color: var(--text-light);">
                    <p>No directory businesses found.</p>
                </div>
                <div id="dirBusinessPagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; padding: 20px 0;">
                    <!-- Pagination will be loaded here -->
                </div>
            </div>

            <!-- Members Directory -->
            <div id="membersDir" class="directory-tab-content" style="display: none;">
                <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn-add" onclick="showDirectoryForm('members')">+ Add New Member</button>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-size: 0.9rem; color: var(--text-light);">Entries per page:</label>
                        <select id="dirMemberPageSize" onchange="changeDirMemberPageSize()" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px;">
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100" selected>100</option>
                            <option value="200">200</option>
                        </select>
                    </div>
                </div>
                <table class="directory-table" style="width: 100%; border-collapse: collapse; background: var(--white); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: none;">
                    <thead style="background: var(--primary); color: var(--white);">
                        <tr>
                            <th style="width: 80px; padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Avatar</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Name</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Title</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Organization</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Website</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Social Media</th>
                            <th style="width: 150px; padding: 10px 8px; text-align: center; font-weight: 600; font-size: 0.9rem; border: none;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="membersDirList">
                        <!-- Members will be loaded here -->
                    </tbody>
                </table>
                <div id="noMembersDirMessage" style="display: none; text-align: center; padding: 40px; color: var(--text-light);">
                    <p>No member entries found. Click "+ Add New Member" to create one.</p>
                </div>
                <div id="dirMemberPagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; padding: 20px 0;">
                    <!-- Pagination will be loaded here -->
                </div>
            </div>

            <!-- Partners Directory -->
            <div id="partnersDir" class="directory-tab-content" style="display: none;">
                <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn-add" onclick="showDirectoryForm('partners')">+ Add New Partner</button>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-size: 0.9rem; color: var(--text-light);">Entries per page:</label>
                        <select id="dirPartnerPageSize" onchange="changeDirPartnerPageSize()" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px;">
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100" selected>100</option>
                            <option value="200">200</option>
                        </select>
                    </div>
                </div>
                <table class="directory-table" style="width: 100%; border-collapse: collapse; background: var(--white); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: none;">
                    <thead style="background: var(--primary); color: var(--white);">
                        <tr>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Address</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Email</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Phone</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Website</th>
                            <th style="width: 150px; padding: 10px 8px; text-align: center; font-weight: 600; font-size: 0.9rem; border: none;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="partnersList">
                        <!-- Partners will be loaded here -->
                    </tbody>
                </table>
                <div id="noPartnersMessage" style="display: none; text-align: center; padding: 40px; color: var(--text-light);">
                    <p>No partner entries found. Click "+ Add New Partner" to create one.</p>
                </div>
                <div id="dirPartnerPagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; padding: 20px 0;">
                    <!-- Pagination will be loaded here -->
                </div>
            </div>

            <!-- Directory Forms -->
            <div id="directoryForm" style="display: none; margin-top: 30px;">
                <div class="card">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--light);">
                        <h4 id="directoryFormTitle" style="margin: 0;">Add/Edit Directory Entry</h4>
                        <span id="directoryTypeBadge" style="padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;"></span>
                    </div>
                    <form id="directoryFormContent">
                        <!-- Form content will be dynamically generated based on directory type -->
                    </form>
                </div>
            </div>
        </div>

        <!-- Homepage Section -->
        <div id="homepage" class="admin-section">
            <h3>Manage Homepage Content</h3>
            <div class="card">
                <h4>Hero Section</h4>
                <form onsubmit="saveHomepageContent(event, 'hero')">
                    <div class="input-group">
                        <label>Main Heading</label>
                        <input type="text" id="heroHeading" value="Empowering Your Business Vision" required>
                    </div>
                    <div class="input-group">
                        <label>Mission Statement</label>
                        <textarea rows="3" id="heroMission" required>Our Mission: To provide the resources, networks, and tools necessary for entrepreneurs to scale and succeed in today's market.</textarea>
                    </div>
                    <div class="input-group">
                        <label>Hero Background Image URL</label>
                        <input type="url" id="heroImage" placeholder="https://...">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h4>Introduction Section</h4>
                <form onsubmit="saveHomepageContent(event, 'intro')">
                    <div class="input-group">
                        <label>Introduction Text</label>
                        <textarea rows="4" id="introText" required>Welcome to your central hub for business growth. We bridge the gap between innovation and capital by providing a streamlined ecosystem for entrepreneurs and investors alike.</textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h4>About Us & Vision</h4>
                <form onsubmit="saveHomepageContent(event, 'about')">
                    <div class="form-grid">
                        <div class="input-group">
                            <label>About Us Text</label>
                            <textarea rows="4" id="aboutText" required>We are a dedicated collective of industry experts focused on fostering economic growth through community-driven funding and education.</textarea>
                        </div>
                        <div class="input-group">
                            <label>Our Vision Text</label>
                            <textarea rows="4" id="visionText" required>To become the global standard for business directories and funding transparency, ensuring every viable idea has the chance to thrive.</textarea>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tools Section -->
        <div id="tools" class="admin-section">
            <h3>Manage Financial Calculators</h3>
            <div class="card">
                <h4>Currency Exchange Rates</h4>
                <form onsubmit="saveToolsSettings(event, 'exchange')">
                    <div class="form-grid">
                        <div class="input-group">
                            <label>NGN to USD Exchange Rate</label>
                            <input type="number" id="ngnToUsd" value="1450" step="0.01" required>
                            <small style="color: var(--text-light);">Used for currency conversion in all calculators</small>
                        </div>
                        <div class="input-group">
                            <label>NGN to GBP Exchange Rate</label>
                            <input type="number" id="ngnToGbp" value="1850" step="0.01" required>
                            <small style="color: var(--text-light);">Used for currency conversion in all calculators</small>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Exchange Rates</button>
                    </div>
                </form>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h4>Calculator Default Values</h4>
                <form onsubmit="saveToolsSettings(event, 'defaults')">
                    <div class="form-grid">
                        <div class="input-group">
                            <label>Business Loan - Default Interest Rate (%)</label>
                            <input type="number" id="loanRate" value="22" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Business Loan - Default Term (Months)</label>
                            <input type="number" id="loanTerm" value="24">
                        </div>
                        <div class="input-group">
                            <label>Mortgage - Default Interest Rate (%)</label>
                            <input type="number" id="mortgageRate" value="16" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Mortgage - Default Term (Years)</label>
                            <input type="number" id="mortgageTerm" value="15">
                        </div>
                        <div class="input-group">
                            <label>Budgeting - Default Tax Rate (%)</label>
                            <input type="number" id="taxRate" value="7.5" step="0.1">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Default Values</button>
                    </div>
                </form>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h4>Tool Visibility Management</h4>
                <p style="color: var(--text-light); margin-bottom: 20px;">Control which tools are visible to users. Hide tools during maintenance or testing.</p>
                
                <div id="toolVisibilityList">
                    <h5 style="margin-top: 20px; margin-bottom: 15px; color: var(--primary);">Built-in Tools</h5>
                    <div id="builtinToolsList" style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- Built-in tools will be loaded here -->
                    </div>
                    
                    <h5 style="margin-top: 30px; margin-bottom: 15px; color: var(--primary);">Custom Tools</h5>
                    <div id="customToolsVisibilityList" style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- Custom tools will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h4>Manage Custom Tools</h4>
                <button class="btn-add" onclick="showToolForm()" style="margin-bottom: 20px;">+ Add New Tool</button>
                
                <div id="toolsList" class="content-grid">
                    <!-- Tools will be loaded here -->
                </div>
            </div>

            <!-- Tool Form (Hidden by default) -->
            <div id="toolForm" class="card" style="margin-top: 20px; display: none;">
                <h4 id="toolFormTitle">Add New Tool</h4>
                <form onsubmit="saveTool(event)">
                    <input type="hidden" id="toolId">
                    
                    <div class="input-group">
                        <label>Tool Name</label>
                        <input type="text" id="toolName" required placeholder="e.g., ROI Calculator">
                    </div>
                    
                    <div class="input-group">
                        <label>Tool Description</label>
                        <textarea id="toolDescription" rows="2" placeholder="Brief description of what this calculator does"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label>Calculation Function (JavaScript)</label>
                        <textarea id="toolFunction" rows="10" required placeholder="function calculateTool() {&#10;    // Your calculation logic here&#10;    // Access inputs with: document.getElementById('input1').value&#10;    // Set result with: document.getElementById('result').innerText = 'Result'&#10;    // Example:&#10;    const value1 = parseFloat(document.getElementById('input1').value) || 0;&#10;    const result = value1 * 2;&#10;    document.getElementById('result').innerText = formatNaira(result);&#10;}"></textarea>
                        <small style="color: var(--text-light);">Write JavaScript function that performs the calculation. Use formatNaira(), formatForeign() for currency formatting.</small>
                    </div>
                    
                    <div class="input-group">
                        <label>Input Fields (JSON)</label>
                        <textarea id="toolInputs" rows="8" required placeholder='[&#10;    {&quot;id&quot;: &quot;input1&quot;, &quot;label&quot;: &quot;Amount (‚Ç¶)&quot;, &quot;type&quot;: &quot;amount&quot;, &quot;value&quot;: &quot;1000000.00&quot;},&#10;    {&quot;id&quot;: &quot;input2&quot;, &quot;label&quot;: &quot;Rate (%)&quot;, &quot;type&quot;: &quot;number&quot;, &quot;value&quot;: &quot;10&quot;}&#10;]'></textarea>
                        <small style="color: var(--text-light);">JSON array of input fields. Types: "amount", "number", "text". For amount fields, use formatAmountInput() on onblur.</small>
                    </div>
                    
                    <div class="input-group">
                        <label>Result Label</label>
                        <input type="text" id="toolResultLabel" required placeholder="e.g., Total Return">
                    </div>
                    
                    <div class="input-group">
                        <label>Result ID (for JavaScript)</label>
                        <input type="text" id="toolResultId" required placeholder="e.g., toolResult">
                        <small style="color: var(--text-light);">Unique ID for the result element (used in your calculation function)</small>
                    </div>
                    
                    <div class="input-group">
                        <label>Button Text</label>
                        <input type="text" id="toolButtonText" required placeholder="e.g., Calculate">
                    </div>
                    
                    <div class="input-group">
                        <label>Button Color</label>
                        <select id="toolButtonColor">
                            <option value="var(--primary)">Primary (Blue)</option>
                            <option value="var(--success)">Success (Green)</option>
                            <option value="var(--accent)">Accent (Orange)</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>Show Currency Conversion?</label>
                        <select id="toolShowConversion">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>Result Box Color</label>
                        <select id="toolResultColor">
                            <option value="default">Default (Blue)</option>
                            <option value="success">Success (Green)</option>
                        </select>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="toolSaveBtn">Save Tool</button>
                        <button type="button" class="btn" onclick="hideToolForm()" style="background: var(--white); border: 1px solid var(--border);">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Templates Section -->
        <div id="templates" class="admin-section">
            <h3>Document Template Downloads</h3>
            <p style="color: var(--text-light); margin-bottom: 20px;">View download statistics for all business document templates.</p>
            
            <div class="card">
                <h4>Download Statistics</h4>
                <div style="margin-bottom: 20px;">
                    <button onclick="refreshTemplateStats()" class="btn-small btn-edit" style="padding: 8px 15px;">üîÑ Refresh Stats</button>
                    <button onclick="resetTemplateStats()" class="btn-small btn-delete" style="padding: 8px 15px; margin-left: 10px;">Reset All Counts</button>
                </div>
                
                <div style="margin-bottom: 15px; padding: 15px; background: var(--light); border-radius: 8px;">
                    <strong>Total Downloads:</strong> <span id="templateTotalDownloads">0</span>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="directory-table" style="width: 100%; border-collapse: collapse; background: var(--white); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: none; table-layout: fixed;">
                        <thead style="background: var(--primary); color: var(--white);">
                            <tr>
                                <th style="width: 35%; padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Template Name</th>
                                <th style="width: 20%; padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Category</th>
                                <th style="width: 10%; padding: 10px 8px; text-align: center; font-weight: 600; font-size: 0.9rem; border: none;">Downloads</th>
                                <th style="width: 35%; padding: 10px 8px; text-align: center; font-weight: 600; font-size: 0.9rem; border: none;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="templateStatsList">
                            <!-- Template download stats will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Newsletter Subscribers Section -->
        <div id="newsletter" class="admin-section">
            <h3>Newsletter Subscribers</h3>
            <p style="color: var(--text-light); margin-bottom: 20px;">View and manage newsletter subscribers.</p>
            
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <input type="text" id="newsletterSearch" placeholder="Search by email..." style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid var(--border); border-radius: 5px;" onkeyup="filterNewsletterSubscribers()">
                <select id="newsletterStatus" onchange="filterNewsletterSubscribers()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 5px;">
                    <option value="all">All Subscribers</option>
                    <option value="active">Active Only</option>
                    <option value="inactive">Inactive Only</option>
                </select>
                <select id="newsletterPageSize" onchange="changeNewsletterPageSize()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 5px;">
                    <option value="25">25 per page</option>
                    <option value="50" selected>50 per page</option>
                    <option value="100">100 per page</option>
                    <option value="200">200 per page</option>
                </select>
                <button onclick="refreshNewsletterSubscribers()" class="btn-small btn-edit" style="padding: 8px 15px;">Refresh</button>
            </div>
            
            <div style="margin-bottom: 15px; padding: 15px; background: var(--light); border-radius: 8px;">
                <strong>Total Subscribers:</strong> <span id="newsletterTotalCount">0</span> | 
                <strong>Active:</strong> <span id="newsletterActiveCount">0</span> | 
                <strong>Inactive:</strong> <span id="newsletterInactiveCount">0</span>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="directory-table" style="width: 100%; border-collapse: collapse; background: var(--white); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: none;">
                    <thead style="background: var(--primary); color: var(--white);">
                        <tr>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Email</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Subscribed Date</th>
                            <th style="padding: 10px 8px; text-align: left; font-weight: 600; font-size: 0.9rem; border: none;">Source</th>
                            <th style="padding: 10px 8px; text-align: center; font-weight: 600; font-size: 0.9rem; border: none;">Status</th>
                            <th style="width: 120px; padding: 10px 8px; text-align: center; font-weight: 600; font-size: 0.9rem; border: none;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="newsletterList">
                        <!-- Newsletter subscribers will be loaded here dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div id="noNewsletterMessage" style="display: none; text-align: center; padding: 40px; color: var(--text-light);">
                <p>No subscribers found.</p>
            </div>
            
            <!-- Pagination Controls -->
            <div id="newsletterPagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; padding: 20px 0;">
                <!-- Pagination will be loaded here -->
            </div>
        </div>
    </main>
</div>

<script>
    // Make showSection globally available
    window.showSection = function(sectionId, clickedElement) {
        // Hide all sections
        document.querySelectorAll('.admin-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Remove active class from all menu items
        document.querySelectorAll('.admin-menu a').forEach(link => {
            link.classList.remove('active');
        });
        
        // Show selected section
        const targetSection = document.getElementById(sectionId);
        if (!targetSection) {
            console.error('Section not found:', sectionId);
            alert('Section not found: ' + sectionId);
            return;
        }
        
        targetSection.classList.add('active');
        
        // Add active class to clicked menu item
        if (clickedElement) {
            clickedElement.classList.add('active');
        } else {
            // If no element provided, find the menu item by sectionId and activate it
            const menuLinks = document.querySelectorAll('.admin-menu a');
            menuLinks.forEach(link => {
                if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(`'${sectionId}'`)) {
                    link.classList.add('active');
                }
            });
        }
        
        // Load section-specific data
        if (sectionId === 'users') {
            loadUsers();
        } else if (sectionId === 'members') {
            loadMembers();
        } else if (sectionId === 'events') {
            loadEvents();
        } else if (sectionId === 'blog') {
            loadBlogPosts();
        } else if (sectionId === 'directories') {
            loadDirectories();
        } else if (sectionId === 'newsletter') {
            loadNewsletterSubscribers();
        } else if (sectionId === 'templates') {
            loadTemplateStats();
        } else if (sectionId === 'tools') {
            loadToolVisibility();
        } else if (sectionId === 'templates') {
            loadTemplateStats();
        }
        
        // Always refresh overview stats when showing overview section
        if (sectionId === 'overview') {
            console.log('Overview section shown, refreshing stats...');
            if (typeof updateOverviewStats === 'function') {
                setTimeout(() => {
                    updateOverviewStats();
                }, 100);
            }
        }
        
        // Load data for specific sections
        try {
            if (sectionId === 'users') {
                console.log('Users section activated, calling loadUsers()');
                if (typeof loadUsers === 'function') {
                    loadUsers();
                } else {
                    console.error('loadUsers function not found!');
                }
            } else if (sectionId === 'members') {
                if (typeof loadMembers === 'function') {
                    loadMembers();
                }
            } else if (sectionId === 'events') {
                if (typeof loadEvents === 'function') {
                    loadEvents();
                }
            } else if (sectionId === 'blog') {
                if (typeof loadBlogPosts === 'function') {
                    loadBlogPosts();
                }
            } else if (sectionId === 'directories') {
                console.log('Directories section activated, calling loadDirectories()');
                if (typeof loadDirectories === 'function') {
                    loadDirectories();
                } else {
                    console.error('loadDirectories function not found!');
                }
            } else if (sectionId === 'newsletter') {
                if (typeof loadNewsletterSubscribers === 'function') {
                    loadNewsletterSubscribers(1);
                }
            } else if (sectionId === 'tools') {
                if (typeof loadTools === 'function') {
                    loadTools();
                    loadToolVisibility();
                }
            } else if (sectionId === 'templates') {
                if (typeof loadTemplateStats === 'function') {
                    loadTemplateStats();
                }
            }
        } catch (error) {
            console.error('Error loading section data:', error);
        }
    };
    
    // ========== EVENTS MANAGEMENT ==========
    let currentEventsPage = 1;
    let eventsPerPage = 100;
    
    async function loadEvents(page = 1) {
        const eventsList = document.getElementById('eventsList');
        const noEventsMessage = document.getElementById('noEventsMessage');
        const paginationDiv = document.getElementById('eventsPagination');
        
        console.log('=== loadEvents called ===', 'page:', page);
        
        if (!eventsList) {
            console.error('eventsList element not found!');
            return;
        }
        
        // Get page size from selector
        const pageSizeSelect = document.getElementById('eventPageSize');
        if (pageSizeSelect) {
            eventsPerPage = parseInt(pageSizeSelect.value) || 100;
        }
        
        // Get admin token
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            console.error('No admin token found!');
            eventsList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-light);">Authentication required. Please log in again.</td></tr>';
            return;
        }
        
        // Show loading state
        eventsList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--text-light);">Loading events...</td></tr>';
        if (paginationDiv) paginationDiv.innerHTML = '';
        
        try {
            // Build URL with pagination
            const url = `/api/admin/events?page=${page}&limit=${eventsPerPage}`;
            
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    sessionStorage.removeItem('adminToken');
                    sessionStorage.removeItem('adminAuthenticated');
                    window.location.href = 'admin-login.html';
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            const events = data.events || [];
            const pagination = data.pagination || {};
            
            console.log('Events from API:', events);
            console.log('Pagination info:', pagination);
            
            // Get search term and filter (client-side for current page)
            const searchTerm = document.getElementById('eventSearch')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('eventFilter')?.value || 'all';
            
            let filteredEvents = events;
            if (searchTerm) {
                filteredEvents = events.filter(event => {
                    const title = (event.title || '').toLowerCase();
                    return title.includes(searchTerm);
                });
            }
            
            if (statusFilter !== 'all') {
                filteredEvents = filteredEvents.filter(event => {
                    const status = (event.status || '').toLowerCase();
                    if (statusFilter === 'featured') return status === 'featured';
                    if (statusFilter === 'live') return status === 'live now';
                    if (statusFilter === 'upcoming') return status === 'upcoming';
                    if (statusFilter === 'historical') return status === 'historical';
                    return true;
                });
            }
            
            // Sort events
            const sortBy = document.getElementById('eventSort')?.value || 'newest';
            filteredEvents.sort((a, b) => {
                if (sortBy === 'newest') {
                    const dateA = a.event_date ? new Date(a.event_date).getTime() : 0;
                    const dateB = b.event_date ? new Date(b.event_date).getTime() : 0;
                    return dateB - dateA;
                } else if (sortBy === 'oldest') {
                    const dateA = a.event_date ? new Date(a.event_date).getTime() : 0;
                    const dateB = b.event_date ? new Date(b.event_date).getTime() : 0;
                    return dateA - dateB;
                } else if (sortBy === 'title') {
                    return (a.title || '').localeCompare(b.title || '');
                } else if (sortBy === 'date') {
                    const dateA = a.event_date ? new Date(a.event_date).getTime() : 0;
                    const dateB = b.event_date ? new Date(b.event_date).getTime() : 0;
                    return dateA - dateB;
                }
                return 0;
            });
            
            if (filteredEvents.length === 0) {
                eventsList.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-light);">${searchTerm || statusFilter !== 'all' ? 'No events match your filters.' : 'No events found. Click "+ Add New Event" to create one.'}</td></tr>`;
                if (noEventsMessage) noEventsMessage.style.display = 'none';
                if (paginationDiv) paginationDiv.innerHTML = '';
                return;
            }
            
            if (noEventsMessage) noEventsMessage.style.display = 'none';
            
            // Update current page
            currentEventsPage = pagination.page || page;
            
            const statusColors = {
                'Upcoming': 'var(--accent)',
                'Live Now': 'var(--live)',
                'Featured': 'var(--accent)',
                'Historical': 'var(--text-light)'
            };
            
            // Render events in table format
            eventsList.innerHTML = filteredEvents.map(event => {
                const dateDisplay = event.date_display || event.dateDisplay || (event.event_date ? new Date(event.event_date).toLocaleDateString() : 'TBD');
                const eventType = event.event_type || event.eventType || 'regular';
                
                // Parse social links and create icons
                let socialLinksHTML = '';
                if (event.social_links) {
                    try {
                        const links = typeof event.social_links === 'string' ? JSON.parse(event.social_links) : event.social_links;
                        const socialIcons = {
                            linkedin: { icon: 'üíº', name: 'LinkedIn' },
                            instagram: { icon: 'üì∑', name: 'Instagram' },
                            twitter: { icon: 'üê¶', name: 'Twitter' },
                            youtube: { icon: '‚ñ∂Ô∏è', name: 'YouTube' }
                        };
                        
                        const availableLinks = [];
                        // Escape URLs to prevent XSS
                        const escapeUrl = (url) => {
                            if (!url) return '';
                            return String(url).replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        };
                        
                        if (links.linkedin) {
                            const safeUrl = escapeUrl(links.linkedin);
                            availableLinks.push(`<a href="${safeUrl}" target="_blank" rel="noopener noreferrer" title="LinkedIn" style="text-decoration: none; font-size: 1.2rem; margin: 0 3px; display: inline-block; color: #0077b5; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">üíº</a>`);
                        }
                        if (links.instagram) {
                            const safeUrl = escapeUrl(links.instagram);
                            availableLinks.push(`<a href="${safeUrl}" target="_blank" rel="noopener noreferrer" title="Instagram" style="text-decoration: none; font-size: 1.2rem; margin: 0 3px; display: inline-block; color: #E4405F; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">üì∑</a>`);
                        }
                        if (links.twitter) {
                            const safeUrl = escapeUrl(links.twitter);
                            availableLinks.push(`<a href="${safeUrl}" target="_blank" rel="noopener noreferrer" title="Twitter" style="text-decoration: none; font-size: 1.2rem; margin: 0 3px; display: inline-block; color: #1DA1F2; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">üê¶</a>`);
                        }
                        if (links.youtube) {
                            const safeUrl = escapeUrl(links.youtube);
                            availableLinks.push(`<a href="${safeUrl}" target="_blank" rel="noopener noreferrer" title="YouTube" style="text-decoration: none; font-size: 1.2rem; margin: 0 3px; display: inline-block; color: #FF0000; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">‚ñ∂Ô∏è</a>`);
                        }
                        
                        socialLinksHTML = availableLinks.length > 0 ? availableLinks.join('') : '<span style="color: var(--text-light);">No links</span>';
                    } catch (e) {
                        socialLinksHTML = '<span style="color: var(--text-light);">No links</span>';
                    }
                } else {
                    socialLinksHTML = '<span style="color: var(--text-light);">No links</span>';
                }
                
                return `
                    <tr style="border-bottom: 1px solid var(--border);" data-event-id="${event.id}">
                        <td style="padding: 10px 8px; border: none; vertical-align: middle; font-weight: 600; color: var(--primary);">${event.title || 'Untitled Event'}</td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;"><span style="color: ${eventType === 'pitch' ? 'var(--primary)' : 'var(--text-light)'};">${eventType === 'pitch' ? 'Pitch Event' : 'Regular Event'}</span></td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;">${dateDisplay}</td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle; text-align: center;">${socialLinksHTML}</td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;">
                            <select onchange="updateEventStatus('${event.id}', this.value, '${(event.title || 'Untitled Event').replace(/'/g, "\\'")}')" style="padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.85rem; background: white; cursor: pointer; color: ${statusColors[event.status] || 'var(--accent)'}; font-weight: 500; min-width: 100px;" value="${event.status || 'Upcoming'}">
                                <option value="Upcoming" ${(event.status || 'Upcoming') === 'Upcoming' ? 'selected' : ''}>Upcoming</option>
                                <option value="Live Now" ${event.status === 'Live Now' ? 'selected' : ''}>Live Now</option>
                                <option value="Featured" ${event.status === 'Featured' ? 'selected' : ''}>Featured</option>
                                <option value="Historical" ${event.status === 'Historical' ? 'selected' : ''}>Historical</option>
                            </select>
                        </td>
                        ${event.status === 'Historical' ? '<td style="padding: 10px 8px; border: none; vertical-align: middle; text-align: center;">-</td>' : `<td style="padding: 10px 8px; border: none; vertical-align: middle; text-align: center;"><span style="font-weight: 600; color: var(--primary);">${event.rsvp_count || 0}</span></td>`}
                        <td style="padding: 10px 8px; border: none; vertical-align: middle; white-space: nowrap;">
                            <div style="display: flex; align-items: center; gap: 5px; justify-content: center; flex-wrap: nowrap;">
                                ${event.status === 'Historical' ? `
                                    <button class="btn-small btn-edit" onclick="copyEvent('${event.id}')" style="margin: 0; font-size: 0.85rem; padding: 6px 12px;">Copy</button>
                                    <button class="btn-small btn-delete" onclick="archiveEvent('${event.id}', '${(event.title || 'Untitled Event').replace(/'/g, "\\'")}')" style="margin: 0; font-size: 0.85rem; padding: 6px 12px; background: #6b7280; border-color: #6b7280;">Archive</button>
                                ` : `
                                    <button class="btn-small btn-edit" onclick="viewEventRSVPs('${event.id}', '${(event.title || 'Untitled Event').replace(/'/g, "\\'")}')" style="margin: 0; font-size: 0.85rem; padding: 6px 10px;">View RSVPs</button>
                                    <button class="btn-small btn-edit" onclick="editEvent('${event.id}')" style="margin: 0; font-size: 0.85rem; padding: 6px 10px;">Edit</button>
                                    <button class="btn-small btn-delete" onclick="deleteEvent('${event.id}')" style="margin: 0; font-size: 0.85rem; padding: 6px 10px;">Delete</button>
                                `}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Add hover effect
            const rows = eventsList.querySelectorAll('tr');
            rows.forEach(row => {
                row.style.cursor = 'pointer';
                row.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = 'var(--light)';
                });
                row.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });
            });
            
            // Render pagination
            if (paginationDiv && pagination.pages > 1) {
                let paginationHTML = '<div style="display: flex; align-items: center; gap: 10px;">';
                if (pagination.has_prev) {
                    paginationHTML += `<button class="btn-small btn-edit" onclick="loadEvents(${currentEventsPage - 1})" style="padding: 8px 15px;">Previous</button>`;
                } else {
                    paginationHTML += `<button class="btn-small" disabled style="padding: 8px 15px; opacity: 0.5; cursor: not-allowed;">Previous</button>`;
                }
                paginationHTML += `<span style="padding: 0 15px;">Page ${pagination.page} of ${pagination.pages} (${pagination.total} total)</span>`;
                if (pagination.has_next) {
                    paginationHTML += `<button class="btn-small btn-edit" onclick="loadEvents(${currentEventsPage + 1})" style="padding: 8px 15px;">Next</button>`;
                } else {
                    paginationHTML += `<button class="btn-small" disabled style="padding: 8px 15px; opacity: 0.5; cursor: not-allowed;">Next</button>`;
                }
                paginationHTML += '</div>';
                paginationDiv.innerHTML = paginationHTML;
            } else if (paginationDiv) {
                paginationDiv.innerHTML = '';
            }
            
            console.log('Events rendered successfully. Total displayed:', filteredEvents.length);
        } catch (error) {
            console.error('Error loading events:', error);
            eventsList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--live);">Error loading events. Please try again.</td></tr>';
            if (noEventsMessage) noEventsMessage.style.display = 'none';
            if (paginationDiv) paginationDiv.innerHTML = '';
        }
    }
    
    function changeEventPageSize() {
        const pageSizeSelect = document.getElementById('eventPageSize');
        if (pageSizeSelect) {
            eventsPerPage = parseInt(pageSizeSelect.value) || 100;
        }
        loadEvents(1); // Reset to page 1
    }
    
    function filterEvents() {
        loadEvents(1); // Reset to page 1 when filtering
    }
    
    function sortEvents() {
        loadEvents(currentEventsPage); // Keep current page
    }
    
    function refreshEvents() {
        const searchInput = document.getElementById('eventSearch');
        if (searchInput) {
            searchInput.value = '';
        }
        loadEvents(1);
    }

    function showEventForm(eventId = null, skipReset = false) {
        const form = document.getElementById('eventForm');
        const formTitle = document.getElementById('eventFormTitle');
        const saveBtn = document.getElementById('eventSaveBtn');
        
        // Only reset form if creating new event (not editing)
        if (!skipReset && !eventId) {
            document.getElementById('eventId').value = '';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('eventTime').value = '';
            document.getElementById('eventType').value = 'regular';
            document.getElementById('eventStatus').value = 'Upcoming';
            document.getElementById('eventDescription').value = '';
            document.getElementById('eventSocialLinks').value = '';
            
            // Reset flier preview
            const preview = document.getElementById('eventFlierPreview');
            const placeholder = document.getElementById('eventFlierPlaceholder');
            const urlInput = document.getElementById('eventFlierURL');
            const fileInput = document.getElementById('eventFlierUpload');
            if (preview) {
                preview.src = '';
                preview.style.display = 'none';
            }
            if (placeholder) {
                placeholder.style.display = 'block';
            }
            if (urlInput) {
                urlInput.value = '';
            }
            if (fileInput) {
                fileInput.value = '';
            }
        }
        
        if (eventId) {
            formTitle.textContent = 'Edit Event';
            saveBtn.textContent = 'Update Event';
        } else {
            formTitle.textContent = 'Add New Event';
            saveBtn.textContent = 'Save Event';
        }
        
        form.style.display = 'block';
        form.scrollIntoView({ behavior: 'smooth' });
    }
    
    async function editEvent(eventId) {
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Authentication required. Please log in again.');
            window.location.href = 'admin-login.html';
            return;
        }

        try {
            // Fetch event from API
            const response = await fetch(`/api/admin/events?page=1&limit=1000`, {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    sessionStorage.removeItem('adminToken');
                    sessionStorage.removeItem('adminAuthenticated');
                    window.location.href = 'admin-login.html';
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            const events = data.events || [];
            const event = events.find(e => e.id.toString() === eventId.toString());

            if (!event) {
                alert('Event not found!');
                return;
            }

            // Populate form with API data
            document.getElementById('eventId').value = event.id;
            document.getElementById('eventTitle').value = event.title || '';
            
            // Format date for HTML date input (YYYY-MM-DD format)
            let formattedDate = '';
            if (event.event_date) {
                const dateObj = new Date(event.event_date);
                if (!isNaN(dateObj.getTime())) {
                    // Format as YYYY-MM-DD for HTML date input
                    const year = dateObj.getFullYear();
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    formattedDate = `${year}-${month}-${day}`;
                } else {
                    formattedDate = event.event_date; // Fallback to original value
                }
            }
            document.getElementById('eventDate').value = formattedDate;
            
            // Format time for HTML time input (HH:MM format)
            let formattedTime = '';
            if (event.event_time) {
                // If time is already in HH:MM format, use it directly
                if (/^\d{2}:\d{2}$/.test(event.event_time)) {
                    formattedTime = event.event_time;
                } else {
                    // Try to parse and format the time
                    const timeMatch = event.event_time.match(/(\d{1,2}):(\d{2})/);
                    if (timeMatch) {
                        const hours = String(parseInt(timeMatch[1])).padStart(2, '0');
                        const minutes = timeMatch[2];
                        formattedTime = `${hours}:${minutes}`;
                    } else {
                        formattedTime = event.event_time; // Fallback to original value
                    }
                }
            }
            document.getElementById('eventTime').value = formattedTime;
            
            document.getElementById('eventType').value = event.event_type || 'regular';
            document.getElementById('eventStatus').value = event.status || 'Upcoming';
            document.getElementById('eventDescription').value = event.description || '';
            
            // Parse social_links if it's a JSON string
            let socialLinksValue = '';
            if (event.social_links) {
                try {
                    const links = typeof event.social_links === 'string' ? JSON.parse(event.social_links) : event.social_links;
                    socialLinksValue = JSON.stringify(links, null, 2);
                } catch (e) {
                    socialLinksValue = event.social_links;
                }
            }
            document.getElementById('eventSocialLinks').value = socialLinksValue;
            
            // Format date_display if needed
            if (event.date_display) {
                // date_display is already formatted, no need to set it separately
            } else if (event.event_date) {
                const date = new Date(event.event_date);
                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const timeStr = event.event_time || '';
                // date_display will be auto-generated on save if not set
            }

            // Load flier if available
            const flierPreview = document.getElementById('eventFlierPreview');
            const flierPlaceholder = document.getElementById('eventFlierPlaceholder');
            const flierURL = document.getElementById('eventFlierURL');
            if (event.flier_url) {
                if (event.flier_url.startsWith('data:')) {
                    flierPreview.src = event.flier_url;
                    flierPreview.style.display = 'block';
                    flierPlaceholder.style.display = 'none';
                } else {
                    flierURL.value = event.flier_url;
                    flierPreview.src = event.flier_url;
                    flierPreview.style.display = 'block';
                    flierPlaceholder.style.display = 'none';
                }
            }

            // Show form (skip reset since we just populated it)
            showEventForm(eventId, true);
        } catch (error) {
            console.error('Error loading event:', error);
            alert('Failed to load event. Please try again.');
        }
    }
    
    // View RSVPs for an event
    async function viewEventRSVPs(eventId, eventTitle) {
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Authentication required. Please log in again.');
            window.location.href = 'admin-login.html';
            return;
        }

        try {
            const response = await fetch(`/api/admin/events/${eventId}/rsvps?limit=100`, {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    sessionStorage.removeItem('adminToken');
                    sessionStorage.removeItem('adminAuthenticated');
                    window.location.href = 'admin-login.html';
                    return;
                }
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            const rsvps = data.rsvps || [];
            const total = data.pagination?.total || 0;

            // Create modal HTML
            const modalHTML = `
                <div id="rsvpModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 8px; padding: 30px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; color: var(--primary);">RSVPs for: ${eventTitle}</h2>
                            <button onclick="closeRSVPModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light);">&times;</button>
                        </div>
                        <p style="color: var(--text-light); margin-bottom: 20px;">Total Registered: <strong style="color: var(--primary);">${total}</strong></p>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: var(--primary); color: white;">
                                        <th style="padding: 10px; text-align: left; border: none;">Name</th>
                                        <th style="padding: 10px; text-align: left; border: none;">Email</th>
                                        <th style="padding: 10px; text-align: left; border: none;">Phone</th>
                                        <th style="padding: 10px; text-align: left; border: none;">Registered Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rsvps.length > 0 ? rsvps.map(rsvp => `
                                        <tr style="border-bottom: 1px solid var(--border);">
                                            <td style="padding: 10px; border: none;">${rsvp.name || 'N/A'}</td>
                                            <td style="padding: 10px; border: none;">${rsvp.email || 'N/A'}</td>
                                            <td style="padding: 10px; border: none;">${rsvp.phone || 'N/A'}</td>
                                            <td style="padding: 10px; border: none;">${rsvp.rsvp_date ? new Date(rsvp.rsvp_date).toLocaleString() : 'N/A'}</td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="4" style="padding: 20px; text-align: center; color: var(--text-light);">No RSVPs yet</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('rsvpModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        } catch (error) {
            console.error('Error loading RSVPs:', error);
            alert('Failed to load RSVPs: ' + error.message);
        }
    }

    function closeRSVPModal() {
        const modal = document.getElementById('rsvpModal');
        if (modal) {
            modal.remove();
        }
    }

    // Update event status
    async function updateEventStatus(eventId, newStatus, eventTitle) {
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Authentication required. Please log in again.');
            window.location.href = 'admin-login.html';
            return;
        }

        if (!confirm(`Change status of "${eventTitle}" to "${newStatus}"?`)) {
            // Reset dropdown to original value
            loadEvents(currentEventsPage);
            return;
        }

        try {
            const response = await fetch(`/api/admin/events/${eventId}/status`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: newStatus })
            });

            if (!response.ok) {
                if (response.status === 401) {
                    sessionStorage.removeItem('adminToken');
                    sessionStorage.removeItem('adminAuthenticated');
                    window.location.href = 'admin-login.html';
                    return;
                }
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            alert(`Event status updated to "${newStatus}" successfully!`);
            loadEvents(currentEventsPage); // Reload to refresh display
        } catch (error) {
            console.error('Error updating event status:', error);
            alert('Failed to update event status: ' + error.message);
            loadEvents(currentEventsPage); // Reload to reset dropdown
        }
    }

    // Bulk update all event statuses based on dates
    async function bulkUpdateEventStatuses() {
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Authentication required. Please log in again.');
            window.location.href = 'admin-login.html';
            return;
        }

        if (!confirm('This will automatically update all event statuses based on their dates:\n\n- Events today ‚Üí "Live Now"\n- Past events ‚Üí "Historical"\n- Future events ‚Üí "Upcoming"\n\nContinue?')) {
            return;
        }

        try {
            const response = await fetch('/api/admin/events/update-statuses', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    sessionStorage.removeItem('adminToken');
                    sessionStorage.removeItem('adminAuthenticated');
                    window.location.href = 'admin-login.html';
                    return;
                }
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            const summary = data.summary;
            
            let message = `‚úÖ Status update complete!\n\n`;
            message += `Total events: ${summary.totalEvents}\n`;
            message += `Updated: ${summary.updated}\n`;
            if (summary.liveNow > 0) message += `- Set to "Live Now": ${summary.liveNow}\n`;
            if (summary.historical > 0) message += `- Set to "Historical": ${summary.historical}\n`;
            if (summary.upcoming > 0) message += `- Set to "Upcoming": ${summary.upcoming}\n`;
            message += `Unchanged: ${summary.unchanged}`;
            
            alert(message);
            loadEvents(currentEventsPage); // Reload to refresh display
        } catch (error) {
            console.error('Error bulk updating event statuses:', error);
            alert('Failed to update event statuses: ' + error.message);
        }
    }

    async function deleteEvent(eventId) {
        if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
            return;
        }

        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Authentication required. Please log in again.');
            window.location.href = 'admin-login.html';
            return;
        }

        try {
            const response = await fetch(`/api/admin/events/${eventId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    sessionStorage.removeItem('adminToken');
                    sessionStorage.removeItem('adminAuthenticated');
                    window.location.href = 'admin-login.html';
                    return;
                }
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            // Remove from UI
            const eventItem = document.querySelector(`[data-event-id="${eventId}"]`);
            if (eventItem) {
                eventItem.style.transition = 'opacity 0.3s';
                eventItem.style.opacity = '0';
                setTimeout(() => {
                    eventItem.remove();
                    // Reload events to refresh the list
                    loadEvents(currentEventsPage);
                }, 300);
            } else {
                // Reload events if element not found
                loadEvents(currentEventsPage);
            }

            alert('Event deleted successfully!');
        } catch (error) {
            console.error('Error deleting event:', error);
            alert(`Failed to delete event: ${error.message}`);
        }
    }
    
    async function saveEvent(e) {
        e.preventDefault();
        
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Authentication required. Please log in again.');
            window.location.href = 'admin-login.html';
            return;
        }

        const eventId = document.getElementById('eventId').value;
        const title = document.getElementById('eventTitle').value;
        const date = document.getElementById('eventDate').value;
        const time = document.getElementById('eventTime').value;
        const eventTypeSelect = document.getElementById('eventType');
        const eventType = eventTypeSelect ? eventTypeSelect.value : 'regular';
        const status = document.getElementById('eventStatus').value || 'Upcoming';
        const description = document.getElementById('eventDescription').value;
        const socialLinksInput = document.getElementById('eventSocialLinks').value;
        
        // Get flier data
        const flierPreview = document.getElementById('eventFlierPreview');
        const flierURL = document.getElementById('eventFlierURL').value;
        let flierData = null;
        if (flierPreview && flierPreview.style.display === 'block' && flierPreview.src) {
            flierData = flierPreview.src;
        } else if (flierURL) {
            flierData = flierURL;
        }
        
        // Format date for display
        let dateDisplay = null;
        if (date) {
            const dateObj = new Date(date);
            if (!isNaN(dateObj.getTime())) {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                dateDisplay = `${months[dateObj.getMonth()]} ${dateObj.getDate().toString().padStart(2, '0')}, ${dateObj.getFullYear()}`;
                if (time) {
                    // Convert 24-hour to 12-hour format
                    const [hours, minutes] = time.split(':');
                    let hours12 = parseInt(hours);
                    const period = hours12 >= 12 ? 'PM' : 'AM';
                    if (hours12 > 12) hours12 -= 12;
                    if (hours12 === 0) hours12 = 12;
                    dateDisplay += ` - ${hours12}:${minutes} ${period}`;
                }
            }
        }
        
        // Parse social links JSON if provided
        let socialLinks = null;
        if (socialLinksInput && socialLinksInput.trim()) {
            // Check if it's comma-separated values (old format)
            if (socialLinksInput.includes(',') && !socialLinksInput.includes('{')) {
                // Convert comma-separated to empty object (platforms will be shown but not clickable)
                socialLinks = null;
            } else {
                try {
                    // Try to parse as JSON
                    const parsed = JSON.parse(socialLinksInput);
                    socialLinks = JSON.stringify(parsed);
                } catch (e) {
                    // If not valid JSON, set to null (will show default labels)
                    console.warn('Social links not in valid JSON format, using default labels');
                    socialLinks = null;
                }
            }
        }

        // Validate required fields
        if (!title || !title.trim()) {
            alert('Event title is required');
            return;
        }

        try {
            const url = eventId 
                ? `/api/admin/events/${eventId}`
                : '/api/admin/events';
            
            const method = eventId ? 'PUT' : 'POST';
            
            const eventData = {
                title: title.trim(),
                event_date: date || null,
                event_time: time || null,
                date_display: dateDisplay,
                event_type: eventType,
                status: status,
                description: description || null,
                flier_url: flierData || null,
                social_links: socialLinks || null
            };

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${adminToken}`
                },
                body: JSON.stringify(eventData)
            });

            // Check if response is JSON before parsing
            const contentType = response.headers.get('content-type');
            const isJSON = contentType && contentType.includes('application/json');
            
            if (!response.ok) {
                if (response.status === 401) {
                    sessionStorage.removeItem('adminToken');
                    sessionStorage.removeItem('adminAuthenticated');
                    window.location.href = 'admin-login.html';
                    return;
                }
                
                if (isJSON) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                } else {
                    const text = await response.text();
                    console.error('Non-JSON error response:', text.substring(0, 500));
                    throw new Error(`Server error (Status ${response.status}). Check console for details.`);
                }
            }
            
            if (!isJSON) {
                const text = await response.text();
                console.error('Non-JSON success response:', text.substring(0, 200));
                throw new Error('Server returned non-JSON response');
            }

            const result = await response.json();
            alert(eventId ? 'Event updated successfully!' : 'Event created successfully!');
            
            // Reload events to refresh the list
            loadEvents(currentEventsPage);
            hideEventForm();
        } catch (error) {
            console.error('Error saving event:', error);
            alert(`Failed to save event: ${error.message}`);
        }
    }

    function hideEventForm() {
        document.getElementById('eventForm').style.display = 'none';
        // Reset form fields
        document.getElementById('eventId').value = '';
        document.getElementById('eventTitle').value = '';
        document.getElementById('eventDate').value = '';
        document.getElementById('eventTime').value = '';
        document.getElementById('eventType').value = 'regular';
        document.getElementById('eventStatus').value = 'Upcoming';
        document.getElementById('eventDescription').value = '';
        document.getElementById('eventSocialLinks').value = '';
        // Reset flier preview
        const preview = document.getElementById('eventFlierPreview');
        const placeholder = document.getElementById('eventFlierPlaceholder');
        const urlInput = document.getElementById('eventFlierURL');
        if (preview) {
            preview.src = '';
            preview.style.display = 'none';
        }
        if (placeholder) {
            placeholder.style.display = 'block';
        }
        if (urlInput) {
            urlInput.value = '';
        }
    }
    
    function handleEventFlierUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file.');
            return;
        }
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('Image size must be less than 5MB.');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('eventFlierPreview');
            const placeholder = document.getElementById('eventFlierPlaceholder');
            const urlInput = document.getElementById('eventFlierURL');
            
            if (preview) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            // Clear URL input when file is uploaded
            if (urlInput) {
                urlInput.value = '';
            }
        };
        reader.readAsDataURL(file);
    }
    
    // Handle blog image upload
    function handleBlogImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file.');
            event.target.value = '';
            return;
        }
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('Image size must be less than 5MB.');
            event.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('blogImagePreview');
            const placeholder = document.getElementById('blogImagePlaceholder');
            const urlInput = document.getElementById('blogImageURL');
            const statusDiv = document.getElementById('blogImageStatus');
            
            if (preview) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            // Clear URL input when file is uploaded
            if (urlInput) {
                urlInput.value = '';
            }
            if (statusDiv) {
                statusDiv.textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                statusDiv.style.display = 'block';
                statusDiv.style.color = 'var(--success)';
            }
        };
        reader.readAsDataURL(file);
    }
    
    // Convert Giphy share URLs to direct image URLs
    function convertGiphyUrl(url) {
        // Handle Giphy share URLs (e.g., https://giphy.com/gifs/...)
        // Convert to direct image URL format
        const giphyShareMatch = url.match(/giphy\.com\/gifs\/([^\/]+)/);
        if (giphyShareMatch) {
            const gifId = giphyShareMatch[1];
            // Try common Giphy direct image formats
            return `https://media.giphy.com/media/${gifId}/giphy.gif`;
        }
        // If already a direct image URL or other format, return as-is
        return url;
    }
    
    // Handle blog image URL input
    function handleBlogImageURL(event) {
        let url = event.target.value.trim();
        const preview = document.getElementById('blogImagePreview');
        const placeholder = document.getElementById('blogImagePlaceholder');
        const fileInput = document.getElementById('blogImageUpload');
        const statusDiv = document.getElementById('blogImageStatus');
        
        if (url) {
            // Validate URL format
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                if (statusDiv) {
                    statusDiv.textContent = 'Please enter a valid URL starting with http:// or https://';
                    statusDiv.style.display = 'block';
                    statusDiv.style.color = 'var(--live)';
                }
                if (preview) {
                    preview.style.display = 'none';
                }
                if (placeholder) {
                    placeholder.style.display = 'block';
                }
                return;
            }
            
            // Convert Giphy share URLs to direct image URLs
            const originalUrl = url;
            url = convertGiphyUrl(url);
            if (url !== originalUrl) {
                // Update the input field with the converted URL
                event.target.value = url;
                if (statusDiv) {
                    statusDiv.textContent = 'Converted Giphy URL to direct image link';
                    statusDiv.style.display = 'block';
                    statusDiv.style.color = 'var(--accent)';
                }
            }
            
            if (preview) {
                preview.src = url;
                preview.style.display = 'block';
                // Handle image load errors (e.g., CORS issues, invalid URLs)
                preview.onerror = function() {
                    if (statusDiv) {
                        statusDiv.textContent = 'Unable to load image. URL may be invalid or blocked. The URL will still be saved.';
                        statusDiv.style.display = 'block';
                        statusDiv.style.color = 'var(--warning)';
                    }
                    // Don't hide preview - let user see the URL was entered
                };
                preview.onload = function() {
                    if (statusDiv) {
                        statusDiv.textContent = 'Image loaded successfully';
                        statusDiv.style.display = 'block';
                        statusDiv.style.color = 'var(--success)';
                    }
                };
            }
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            // Clear file input when URL is entered
            if (fileInput) {
                fileInput.value = '';
            }
            if (statusDiv && !preview.onerror) {
                statusDiv.textContent = 'Using external image URL';
                statusDiv.style.display = 'block';
                statusDiv.style.color = 'var(--accent)';
            }
        } else {
            if (preview) {
                preview.src = '';
                preview.style.display = 'none';
                preview.onerror = null;
                preview.onload = null;
            }
            if (placeholder) {
                placeholder.style.display = 'block';
            }
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }
    }
    
    function handleEventFlierURL(event) {
        const url = event.target.value;
        const preview = document.getElementById('eventFlierPreview');
        const placeholder = document.getElementById('eventFlierPlaceholder');
        const fileInput = document.getElementById('eventFlierUpload');
        
        if (url && url.startsWith('http')) {
            if (preview) {
                preview.src = url;
                preview.style.display = 'block';
                preview.onerror = function() {
                    alert('Invalid image URL. Please check the URL and try again.');
                    preview.style.display = 'none';
                    if (placeholder) placeholder.style.display = 'block';
                };
            }
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            // Clear file input when URL is used
            if (fileInput) {
                fileInput.value = '';
            }
        } else if (!url) {
            // Reset if URL is cleared
            if (preview) {
                preview.src = '';
                preview.style.display = 'none';
            }
            if (placeholder) {
                placeholder.style.display = 'block';
            }
        }
    }

    function showBlogForm(blogId = null) {
        const form = document.getElementById('blogForm');
        const formTitle = document.getElementById('blogFormTitle');
        const saveBtn = document.getElementById('blogSaveBtn');
        
        // Reset form
        document.getElementById('blogId').value = blogId || '';
        document.getElementById('blogTitle').value = '';
        document.getElementById('blogCategory').value = 'News';
        document.getElementById('blogAuthor').value = '';
        document.getElementById('blogContent').value = '';
        document.getElementById('blogImageURL').value = '';
        const blogImageUpload = document.getElementById('blogImageUpload');
        const blogImagePreview = document.getElementById('blogImagePreview');
        const blogImagePlaceholder = document.getElementById('blogImagePlaceholder');
        const blogImageStatus = document.getElementById('blogImageStatus');
        if (blogImageUpload) blogImageUpload.value = '';
        if (blogImagePreview) {
            blogImagePreview.src = '';
            blogImagePreview.style.display = 'none';
        }
        if (blogImagePlaceholder) blogImagePlaceholder.style.display = 'block';
        if (blogImageStatus) blogImageStatus.style.display = 'none';
        document.getElementById('blogTags').value = '';
        document.getElementById('blogPublishDate').value = '';
        
        if (blogId) {
            formTitle.textContent = 'Edit Blog Post';
            saveBtn.textContent = 'Update Post';
        } else {
            formTitle.textContent = 'Add New Blog Post';
            saveBtn.textContent = 'Save Post';
        }
        
        form.style.display = 'block';
        form.scrollIntoView({ behavior: 'smooth' });
    }
    
    async function saveBlog(e) {
        e.preventDefault();
        
        const blogId = document.getElementById('blogId').value;
        const title = document.getElementById('blogTitle').value;
        const category = document.getElementById('blogCategory').value;
        const author = document.getElementById('blogAuthor').value;
        const content = document.getElementById('blogContent').value;
        const imageURL = document.getElementById('blogImageURL').value;
        const publishDate = document.getElementById('blogPublishDate').value;
        
        if (!title || !content) {
            alert('Title and content are required!');
            return;
        }
        
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('You must be logged in as admin to save blog posts.');
            return;
        }
        
        try {
            // Handle file upload if a file is selected
            let finalImageURL = imageURL.trim() || null;
            const fileInput = document.getElementById('blogImageUpload');
            
            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file.');
                    return;
                }
                
                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image size must be less than 5MB.');
                    return;
                }
                
                // Upload the file
                const formData = new FormData();
                formData.append('image', file);
                
                const uploadResponse = await fetch('/api/admin/blog/upload-image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    const errorData = await uploadResponse.json().catch(() => ({ message: 'Failed to upload image' }));
                    throw new Error(errorData.message || 'Failed to upload image');
                }
                
                const uploadData = await uploadResponse.json();
                finalImageURL = uploadData.url;
            }
            
            const tags = document.getElementById('blogTags').value.trim();
            
            const blogData = {
                title: title.trim(),
                content: content.trim(),
                excerpt: content.substring(0, 200) || null,
                author: author.trim() || null,
                category: category || null,
                featured_image_url: finalImageURL,
                tags: tags || null,
                published_date: publishDate || null,
                is_published: true // Always publish when saving
            };
            
            const url = blogId 
                ? `/api/admin/blog/${blogId}`
                : '/api/admin/blog';
            
            const method = blogId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${adminToken}`
                },
                body: JSON.stringify(blogData)
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'Failed to save blog post' }));
                throw new Error(errorData.message || 'Failed to save blog post');
            }
            
            const savedPost = await response.json();
            
            // Reload blog posts list
            loadBlogPosts();
            
            alert(blogId ? 'Blog post updated successfully!' : 'Blog post created successfully!');
            hideBlogForm();
        } catch (error) {
            console.error('Error saving blog post:', error);
            alert('Error saving blog post: ' + error.message);
        }
    }

    function hideBlogForm() {
        document.getElementById('blogForm').style.display = 'none';
    }
    
    // Load blog posts from API
    async function loadBlogPosts() {
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) return;
        
        try {
            const response = await fetch('/api/admin/blog', {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });
            
            if (!response.ok) throw new Error('Failed to load blog posts');
            
            const posts = await response.json();
            const blogList = document.getElementById('blogList');
            
            if (!blogList) return;
            
            if (posts.length === 0) {
                blogList.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">No blog posts found. Click "+ Add New Post" to create one.</p>';
                return;
            }
            
            blogList.innerHTML = posts.map(post => {
                const publishedDate = post.published_date 
                    ? new Date(post.published_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                    : 'Not published';
                
                return `
                    <div class="content-item" data-blog-id="${post.id}">
                        <h4>${post.title || 'Untitled'}</h4>
                        <p><strong>Category:</strong> ${post.category || 'Uncategorized'}</p>
                        <p><strong>Author:</strong> ${post.author || 'Anonymous'}</p>
                        <p><strong>Published:</strong> ${publishedDate}</p>
                        <p><strong>Status:</strong> ${post.is_published ? '<span style="color: var(--success);">Published</span>' : '<span style="color: var(--text-light);">Draft</span>'}</p>
                        <div class="content-actions">
                            <button class="btn-small btn-edit" onclick="editBlog(${post.id})">Edit</button>
                            <button class="btn-small btn-delete" onclick="deleteBlog(${post.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading blog posts:', error);
            const blogList = document.getElementById('blogList');
            if (blogList) {
                blogList.innerHTML = '<p style="text-align: center; color: var(--live); padding: 40px;">Error loading blog posts. Please refresh the page.</p>';
            }
        }
    }
    
    // Edit blog post - load from API
    async function editBlog(blogId) {
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('You must be logged in as admin.');
            return;
        }
        
        try {
            const response = await fetch(`/api/admin/blog/${blogId}`, {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: `HTTP ${response.status}: ${response.statusText}` }));
                throw new Error(errorData.message || 'Failed to load blog post');
            }
            
            const post = await response.json();
            
            if (!post || !post.id) {
                throw new Error('Invalid blog post data received');
            }
            
            // Populate form
            document.getElementById('blogId').value = post.id;
            document.getElementById('blogTitle').value = post.title || '';
            document.getElementById('blogCategory').value = post.category || 'News';
            document.getElementById('blogAuthor').value = post.author || '';
            document.getElementById('blogContent').value = post.content || '';
            document.getElementById('blogImageURL').value = post.featured_image_url || '';
            // Display existing image if available
            if (post.featured_image_url) {
                const preview = document.getElementById('blogImagePreview');
                const placeholder = document.getElementById('blogImagePlaceholder');
                if (preview && placeholder) {
                    preview.src = post.featured_image_url;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                }
            }
            document.getElementById('blogTags').value = post.tags || '';
            document.getElementById('blogPublishDate').value = post.published_date ? post.published_date.split('T')[0] : '';
            
            // Show form and set title/button without resetting fields
            const form = document.getElementById('blogForm');
            const formTitle = document.getElementById('blogFormTitle');
            const saveBtn = document.getElementById('blogSaveBtn');
            formTitle.textContent = 'Edit Blog Post';
            saveBtn.textContent = 'Update Post';
            form.style.display = 'block';
            form.scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
            console.error('Error loading blog post:', error);
            alert('Error loading blog post: ' + error.message);
        }
    }
    
    // Delete blog post - call API
    async function deleteBlog(blogId) {
        if (!confirm('Are you sure you want to delete this blog post? This action cannot be undone.')) {
            return;
        }
        
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('You must be logged in as admin.');
            return;
        }
        
        try {
            const response = await fetch(`/api/admin/blog/${blogId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });
            
            if (!response.ok) throw new Error('Failed to delete blog post');
            
            // Reload blog posts
            loadBlogPosts();
            alert('Blog post deleted successfully!');
        } catch (error) {
            console.error('Error deleting blog post:', error);
            alert('Error deleting blog post: ' + error.message);
        }
    }

    let currentDirectoryType = '';
    let currentDirectoryId = null;
    
    function showDirectoryForm(type, entryId = null) {
        currentDirectoryType = type;
        currentDirectoryId = entryId;
        const form = document.getElementById('directoryForm');
        const formTitle = document.getElementById('directoryFormTitle');
        const formContent = document.getElementById('directoryFormContent');
        
        // Set form title and badge
        const titles = {
            'business': entryId ? 'Edit Business Entry' : 'Add New Business Entry',
            'members': entryId ? 'Edit Member Entry' : 'Add New Member Entry',
            'partners': entryId ? 'Edit Partner Entry' : 'Add New Partner Entry'
        };
        const badges = {
            'business': { text: 'Business Directory', color: 'var(--accent)', bg: '#ebf8ff' },
            'members': { text: 'Members Directory', color: 'var(--success)', bg: '#f0fff4' },
            'partners': { text: 'Partners Directory', color: 'var(--enterprise)', bg: '#faf5ff' }
        };
        formTitle.textContent = titles[type] || 'Add/Edit Directory Entry';
        
        // Update badge
        const badgeElement = document.getElementById('directoryTypeBadge');
        if (badgeElement && badges[type]) {
            const badge = badges[type];
            badgeElement.textContent = badge.text;
            badgeElement.style.color = badge.color;
            badgeElement.style.background = badge.bg;
            badgeElement.style.display = 'inline-block';
        } else if (badgeElement) {
            badgeElement.style.display = 'none';
        }
        
        // Generate form based on type
        if (type === 'business') {
            // Businesses can be added through admin dashboard to directory_businesses
            // This is handled by the saveDirectoryEntry function for type 'business'
            // No need for special handling here
        } else if (type === 'members') {
            formContent.innerHTML = `
                <form onsubmit="saveDirectoryEntry(event)">
                    <div class="form-grid">
                        <div class="input-group form-full">
                            <label>Name <span style="color: var(--live);">*</span></label>
                            <input type="text" id="dirName" placeholder="Full Name (e.g., David Chen)" required>
                            <small style="color: var(--text-light); font-size: 0.85rem; margin-top: 5px; display: block;">This will be displayed in the Name column</small>
                        </div>
                        <div class="input-group form-full">
                            <label>Avatar Image</label>
                            <div style="display: flex; gap: 10px; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <input type="file" id="memberAvatarUpload" accept="image/*" onchange="handleMemberAvatarUpload(event)" style="padding: 8px; border: 1px solid var(--border); border-radius: 8px; width: 100%;">
                                    <small style="color: var(--text-light); font-size: 0.85rem; margin-top: 5px; display: block;">Upload a square profile image from your device (recommended: 80x80px or larger, max 5MB)</small>
                                </div>
                                <div style="width: 80px; height: 80px; border: 2px solid var(--border); border-radius: 8px; overflow: hidden; background: var(--light); display: flex; align-items: center; justify-content: center;">
                                    <img id="memberAvatarPreview" src="" alt="Avatar Preview" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                    <span id="memberAvatarPlaceholder" style="color: var(--text-light); font-size: 0.75rem; text-align: center; padding: 5px;">Preview</span>
                                </div>
                            </div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
                                <label style="font-size: 0.9rem; color: var(--text-light);">Or use Image URL:</label>
                                <input type="url" id="memberAvatarURL" placeholder="https://... (Alternative: paste image URL)" style="margin-top: 5px;" onchange="handleMemberAvatarURL(event)">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Current Title <span style="color: var(--live);">*</span></label>
                            <input type="text" id="dirTitle" placeholder="Job Title (e.g., Senior Architect)" required>
                            <small style="color: var(--text-light); font-size: 0.85rem; margin-top: 5px; display: block;">Displayed in Current Title column</small>
                        </div>
                        <div class="input-group">
                            <label>Current Organisation <span style="color: var(--live);">*</span></label>
                            <input type="text" id="dirOrg" placeholder="Company Name (e.g., Tech Solutions Inc.)" required>
                            <small style="color: var(--text-light); font-size: 0.85rem; margin-top: 5px; display: block;">Displayed in Current Organisation column</small>
                        </div>
                        <div class="input-group form-full">
                            <label>Personal Website</label>
                            <input type="url" id="dirWebsite" placeholder="https://www.personalwebsite.com">
                            <small style="color: var(--text-light); font-size: 0.85rem; margin-top: 5px; display: block;">Full URL including https://. This will be displayed in the Personal Website column.</small>
                        </div>
                        <div class="input-group">
                            <label>LinkedIn Profile URL</label>
                            <input type="url" id="dirLinkedIn" placeholder="https://www.linkedin.com/in/username">
                        </div>
                        <div class="input-group">
                            <label>Twitter/X Profile URL</label>
                            <input type="url" id="dirTwitter" placeholder="https://twitter.com/username or https://x.com/username">
                        </div>
                        <div class="input-group">
                            <label>Facebook Profile URL</label>
                            <input type="url" id="dirFacebook" placeholder="https://www.facebook.com/username">
                        </div>
                        <div class="input-group">
                            <label>Instagram Profile URL</label>
                            <input type="url" id="dirInstagram" placeholder="https://www.instagram.com/username">
                        </div>
                        <div class="input-group">
                            <label>TikTok Profile URL</label>
                            <input type="url" id="dirTikTok" placeholder="https://www.tiktok.com/@username">
                        </div>
                        <div class="input-group">
                            <label>Threads Profile URL</label>
                            <input type="url" id="dirThreads" placeholder="https://www.threads.net/@username">
                        </div>
                        <div class="input-group">
                            <label>YouTube Channel URL</label>
                            <input type="url" id="dirYouTube" placeholder="https://www.youtube.com/@username or https://www.youtube.com/c/channelname">
                        </div>
                        <div class="input-group">
                            <label>Reddit Profile URL</label>
                            <input type="url" id="dirReddit" placeholder="https://www.reddit.com/user/username">
                        </div>
                        <div class="input-group form-full">
                            <small style="color: var(--text-light); font-size: 0.85rem; margin-top: 5px; display: block;">All provided social media links will appear as icons in the Social Media Profiles column</small>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">${entryId ? 'Update' : 'Save'} Entry</button>
                        <button type="button" class="btn btn-prev" onclick="hideDirectoryForm()">Cancel</button>
                    </div>
                </form>
            `;
        } else if (type === 'partners') {
            formContent.innerHTML = `
                <form onsubmit="saveDirectoryEntry(event)">
                    <div class="form-grid">
                        <div class="input-group form-full">
                            <label>Address <span style="color: var(--live);">*</span></label>
                            <input type="text" id="dirAddress" placeholder="Full address including city, country, postal code" required>
                        </div>
                        <div class="input-group">
                            <label>Email <span style="color: var(--live);">*</span></label>
                            <input type="email" id="dirEmail" placeholder="contact@partner.com" required>
                        </div>
                        <div class="input-group">
                            <label>Phone Number <span style="color: var(--live);">*</span></label>
                            <input type="tel" id="dirPhone" placeholder="+44 20 1234 5678" required>
                        </div>
                        <div class="input-group form-full">
                            <label>Website <span style="color: var(--live);">*</span></label>
                            <input type="url" id="dirWebsite" placeholder="https://www.partner.com" required>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">${entryId ? 'Update' : 'Save'} Entry</button>
                        <button type="button" class="btn btn-prev" onclick="hideDirectoryForm()">Cancel</button>
                    </div>
                </form>
            `;
        }
        
        // Populate form if editing
        if (entryId) {
            setTimeout(() => populateDirectoryForm(type, entryId), 100);
        }
        
        form.style.display = 'block';
        form.scrollIntoView({ behavior: 'smooth' });
    }

    function hideDirectoryForm() {
        document.getElementById('directoryForm').style.display = 'none';
        // Reset avatar preview
        const preview = document.getElementById('memberAvatarPreview');
        const placeholder = document.getElementById('memberAvatarPlaceholder');
        const urlInput = document.getElementById('memberAvatarURL');
        if (preview) {
            preview.src = '';
            preview.style.display = 'none';
        }
        if (placeholder) {
            placeholder.style.display = 'block';
        }
        if (urlInput) {
            urlInput.value = '';
        }
    }
    
    function handleMemberAvatarUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file.');
            return;
        }
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('Image size must be less than 5MB.');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('memberAvatarPreview');
            const placeholder = document.getElementById('memberAvatarPlaceholder');
            const urlInput = document.getElementById('memberAvatarURL');
            
            if (preview) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            // Clear URL input when file is uploaded
            if (urlInput) {
                urlInput.value = '';
            }
        };
        reader.readAsDataURL(file);
    }
    
    function handleMemberAvatarURL(event) {
        const url = event.target.value;
        const preview = document.getElementById('memberAvatarPreview');
        const placeholder = document.getElementById('memberAvatarPlaceholder');
        const fileInput = document.getElementById('memberAvatarUpload');
        
        if (url && url.startsWith('http')) {
            if (preview) {
                preview.src = url;
                preview.style.display = 'block';
                preview.onerror = function() {
                    alert('Invalid image URL. Please check the URL and try again.');
                    preview.style.display = 'none';
                    if (placeholder) placeholder.style.display = 'block';
                };
            }
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            // Clear file input when URL is used
            if (fileInput) {
                fileInput.value = '';
            }
        } else if (!url) {
            // Reset if URL is cleared
            if (preview) {
                preview.src = '';
                preview.style.display = 'none';
            }
            if (placeholder) {
                placeholder.style.display = 'block';
            }
        }
    }

    function showDirectoryTab(tab) {
        // Hide all directory tabs
        document.querySelectorAll('.directory-tab-content').forEach(content => {
            content.style.display = 'none';
        });
        
        // Remove active class from all tab buttons
        document.querySelectorAll('[id$="TabBtn"]').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab and load its data
        if (tab === 'business') {
            document.getElementById('businessDir').style.display = 'block';
            document.getElementById('businessTabBtn').classList.add('active');
            loadBusinessDirectory(1);
        } else if (tab === 'members') {
            document.getElementById('membersDir').style.display = 'block';
            document.getElementById('membersTabBtn').classList.add('active');
            loadMembersDirectory(1);
        } else if (tab === 'partners') {
            document.getElementById('partnersDir').style.display = 'block';
            document.getElementById('partnersTabBtn').classList.add('active');
            loadPartnersDirectory(1);
        }
    }
    
    // Save directory entry (business, member, or partner)
    async function saveDirectoryEntry(e) {
        e.preventDefault();
        
        const type = currentDirectoryType;
        const entryId = currentDirectoryId;
        
        if (!type) {
            alert('Error: Directory type not set.');
            return;
        }
        
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Authentication required. Please log in again.');
            window.location.href = 'admin-login.html';
            return;
        }
        
        try {
            if (type === 'members') {
                // Get member data
                const name = document.getElementById('dirName').value.trim();
                const title = document.getElementById('dirTitle').value.trim();
                const organization = document.getElementById('dirOrg').value.trim();
                const website = document.getElementById('dirWebsite').value.trim();
                const linkedin = document.getElementById('dirLinkedIn').value.trim();
                const twitter = document.getElementById('dirTwitter').value.trim();
                const facebook = document.getElementById('dirFacebook')?.value.trim() || '';
                const instagram = document.getElementById('dirInstagram')?.value.trim() || '';
                const tiktok = document.getElementById('dirTikTok')?.value.trim() || '';
                const threads = document.getElementById('dirThreads')?.value.trim() || '';
                const youtube = document.getElementById('dirYouTube')?.value.trim() || '';
                const reddit = document.getElementById('dirReddit')?.value.trim() || '';
                
                // Get avatar
                const avatarPreview = document.getElementById('memberAvatarPreview');
                const avatarURL = document.getElementById('memberAvatarURL').value.trim();
                let avatar = '';
                if (avatarPreview && avatarPreview.style.display === 'block' && avatarPreview.src) {
                    avatar = avatarPreview.src;
                } else if (avatarURL) {
                    avatar = avatarURL;
                }
                
                const memberData = {
                    name: name,
                    title: title || null,
                    organization: organization || null,
                    website: website || null,
                    linkedin_url: linkedin || null,
                    twitter_url: twitter || null,
                    facebook_url: facebook || null,
                    instagram_url: instagram || null,
                    tiktok_url: tiktok || null,
                    threads_url: threads || null,
                    youtube_url: youtube || null,
                    reddit_url: reddit || null,
                    avatar_url: avatar || null
                };
                
                const url = entryId 
                    ? `/api/admin/directories/members/${entryId}`
                    : '/api/admin/directories/members';
                const method = entryId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify(memberData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to save member');
                }
                
                alert(entryId ? 'Member updated successfully!' : 'Member added successfully!');
                loadMembersDirectory(currentDirMemberPage);
                updateOverviewStats();
                
            } else if (type === 'business') {
                // Businesses can be added to directory_businesses through admin dashboard
                // This will be handled by the saveDirectoryEntry function
                // Continue with the normal flow
            } else if (type === 'partners') {
                // Get partner data
                const partnerData = {
                    address: document.getElementById('dirAddress').value.trim(),
                    email: document.getElementById('dirEmail').value.trim(),
                    phone: document.getElementById('dirPhone').value.trim(),
                    website: document.getElementById('dirWebsite').value.trim()
                };
                
                const url = entryId 
                    ? `/api/admin/directories/partners/${entryId}`
                    : '/api/admin/directories/partners';
                const method = entryId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify(partnerData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to save partner');
                }
                
                alert(entryId ? 'Partner updated successfully!' : 'Partner added successfully!');
                loadPartnersDirectory(currentDirPartnerPage);
                updateOverviewStats();
            }
            
            hideDirectoryForm();
        } catch (error) {
            console.error('Error saving directory entry:', error);
            alert('Error: ' + error.message);
        }
    }
    
    function loadDirectories() {
        // Load the currently active directory tab
        const activeTab = document.querySelector('.directory-tab-content[style*="block"]') || document.getElementById('businessDir');
        if (activeTab) {
            if (activeTab.id === 'businessDir') {
                loadBusinessDirectory(1);
            } else if (activeTab.id === 'membersDir') {
                loadMembersDirectory(1);
            } else if (activeTab.id === 'partnersDir') {
                loadPartnersDirectory(1);
            }
        }
    }
    
    // Directory pagination variables
    let currentDirBusinessPage = 1;
    let currentDirMemberPage = 1;
    let currentDirPartnerPage = 1;
    let dirBusinessPerPage = 100;
    let dirMemberPerPage = 100;
    let dirPartnerPerPage = 100;
    
    async function loadBusinessDirectory(page = 1) {
        const businessList = document.getElementById('businessList');
        const noDirBusinessMessage = document.getElementById('noDirBusinessMessage');
        const paginationDiv = document.getElementById('dirBusinessPagination');
        
        if (!businessList) return;
        
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            businessList.innerHTML = '';
            if (noDirBusinessMessage) noDirBusinessMessage.style.display = 'block';
            return;
        }
        
        // Show loading state
        businessList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-light);">Loading businesses...</td></tr>';
        
        try {
            const response = await fetch(`/api/admin/directories/business?page=${page}&limit=${dirBusinessPerPage}`, {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = 'admin-login.html';
                    return;
                }
                throw new Error('Failed to load businesses');
            }
            
            const data = await response.json();
            const businesses = data.entries || data.businesses || [];
            const pagination = data.pagination || { page: 1, pages: 1, total: 0 };
            
            if (businesses.length === 0) {
                businessList.innerHTML = '';
                if (noDirBusinessMessage) noDirBusinessMessage.style.display = 'block';
                if (paginationDiv) paginationDiv.innerHTML = '';
                return;
            }
            
            if (noDirBusinessMessage) noDirBusinessMessage.style.display = 'none';
            currentDirBusinessPage = pagination.page || page;
            
            businessList.innerHTML = businesses.map((business) => `
                <tr style="border-bottom: 1px solid var(--border);" data-business-id="${business.id}">
                    <td style="padding: 10px 8px; border: none; vertical-align: middle; font-weight: 600; color: var(--primary);">${business.business_name || 'Untitled Business'}</td>
                    <td style="padding: 10px 8px; border: none; vertical-align: middle;">${business.address || 'N/A'}</td>
                    <td style="padding: 10px 8px; border: none; vertical-align: middle;">${business.email ? `<a href="mailto:${business.email}">${business.email}</a>` : 'N/A'}</td>
                    <td style="padding: 10px 8px; border: none; vertical-align: middle;">${business.phone || 'N/A'}</td>
                    <td style="padding: 10px 8px; border: none; vertical-align: middle;">${business.website ? `<a href="${business.website}" target="_blank" rel="noopener noreferrer">${business.website.replace(/^https?:\/\//, '')}</a>` : 'N/A'}</td>
                    <td style="padding: 10px 8px; border: none; vertical-align: middle; white-space: nowrap;">
                        <div style="display: flex; align-items: center; gap: 5px; justify-content: center; flex-wrap: nowrap;">
                            <button class="btn-small btn-edit" onclick="editDirectoryEntry('business', '${business.id}')" style="margin: 0; padding: 6px 12px; font-size: 0.85rem; white-space: nowrap;">Edit</button>
                            <button class="btn-small btn-delete" onclick="deleteDirectoryEntry('business', '${business.id}')" style="margin: 0; padding: 6px 12px; font-size: 0.85rem; white-space: nowrap;">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // Render pagination
            if (paginationDiv && pagination.pages > 1) {
                let paginationHTML = '<div style="display: flex; align-items: center; gap: 10px;">';
                if (pagination.has_prev) {
                    paginationHTML += `<button class="btn-small btn-edit" onclick="loadBusinessDirectory(${currentDirBusinessPage - 1})" style="padding: 8px 15px;">Previous</button>`;
                } else {
                    paginationHTML += `<button class="btn-small" disabled style="padding: 8px 15px; opacity: 0.5; cursor: not-allowed;">Previous</button>`;
                }
                paginationHTML += `<span style="padding: 0 15px;">Page ${pagination.page} of ${pagination.pages} (${pagination.total} total)</span>`;
                if (pagination.has_next) {
                    paginationHTML += `<button class="btn-small btn-edit" onclick="loadBusinessDirectory(${currentDirBusinessPage + 1})" style="padding: 8px 15px;">Next</button>`;
                } else {
                    paginationHTML += `<button class="btn-small" disabled style="padding: 8px 15px; opacity: 0.5; cursor: not-allowed;">Next</button>`;
                }
                paginationHTML += '</div>';
                paginationDiv.innerHTML = paginationHTML;
            } else if (paginationDiv) {
                paginationDiv.innerHTML = '';
            }
        } catch (error) {
            console.error('Error loading business directory:', error);
            businessList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--live);">Error loading businesses. Please try again.</td></tr>';
        }
    }
    
    function changeDirBusinessPageSize() {
        const pageSizeSelect = document.getElementById('dirBusinessPageSize');
        if (pageSizeSelect) {
            dirBusinessPerPage = parseInt(pageSizeSelect.value) || 100;
        }
        loadBusinessDirectory(1);
    }
    
    async function loadMembersDirectory(page = 1) {
        const membersList = document.getElementById('membersDirList');
        const noMembersMessage = document.getElementById('noMembersDirMessage');
        const paginationDiv = document.getElementById('dirMemberPagination');
        
        if (!membersList) return;
        
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            membersList.innerHTML = '';
            if (noMembersMessage) {
                noMembersMessage.style.display = 'block';
            }
            return;
        }
        
        // Show loading state
        membersList.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-light);">Loading members...</td></tr>';
        
        try {
            const response = await fetch(`/api/admin/directories/members?page=${page}&limit=${dirMemberPerPage}`, {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = 'admin-login.html';
                    return;
                }
                throw new Error('Failed to load members');
            }
            
            const data = await response.json();
            const members = data.entries || [];
            const pagination = data.pagination || { page: 1, pages: 1, total: 0 };
            
            if (members.length === 0) {
                membersList.innerHTML = '';
                if (noMembersMessage) {
                    noMembersMessage.style.display = 'block';
                }
                if (paginationDiv) paginationDiv.innerHTML = '';
                return;
            }
            
            if (noMembersMessage) {
                noMembersMessage.style.display = 'none';
            }
            currentDirMemberPage = pagination.page || page;
            
            // Function to generate social media icon
            function getSocialMediaIcon(platform, url) {
                if (!url) return '';
                
                const icons = {
                    linkedin: { color: '#0077b5', svg: '<path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>' },
                    twitter: { color: '#1DA1F2', svg: '<path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>' },
                    facebook: { color: '#1877F2', svg: '<path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>' },
                    instagram: { color: '#E4405F', svg: '<path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>' },
                    tiktok: { color: '#000000', svg: '<path d="M19.59 6.69a4.83 4.83 0 01-1.4-.13v6.05a7.5 7.5 0 01-7.5 7.5c-4.14 0-7.5-3.36-7.5-7.5s3.36-7.5 7.5-7.5c.81 0 1.59.13 2.32.36v2.46a5.05 5.05 0 00-2.32-.56c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5V3h2.48a4.79 4.79 0 001.4 3.69z"/>' },
                    threads: { color: '#000000', svg: '<path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.568 8.16c-.169 0-.306.137-.306.306v7.068c0 .169.137.306.306.306h.612c.169 0 .306-.137.306-.306V8.466c0-.169-.137-.306-.306-.306h-.612zm-2.142 1.836c-.169 0-.306.137-.306.306v5.232c0 .169.137.306.306.306h.612c.169 0 .306-.137.306-.306v-5.232c0-.169-.137-.306-.306-.306h-.612zm-2.142 1.836c-.169 0-.306.137-.306.306v3.396c0 .169.137.306.306.306h.612c.169 0 .306-.137.306-.306v-3.396c0-.169-.137-.306-.306-.306h-.612zm-2.142 1.836c-.169 0-.306.137-.306.306v1.56c0 .169.137.306.306.306h.612c.169 0 .306-.137.306-.306v-1.56c0-.169-.137-.306-.306-.306h-.612z"/>' },
                    youtube: { color: '#FF0000', svg: '<path d="M23.498 6.186a3.016 3.016 0 00-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 00.502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 002.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 002.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>' },
                    reddit: { color: '#FF4500', svg: '<path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c1.69 0 3.06 1.37 3.06 3.06 0 1.69-1.37 3.06-3.06 3.06-1.69 0-3.06-1.37-3.06-3.06 0-1.69 1.37-3.06 3.06-3.06zm-10.02 0c1.69 0 3.06 1.37 3.06 3.06 0 1.69-1.37 3.06-3.06 3.06-1.69 0-3.06-1.37-3.06-3.06 0-1.69 1.37-3.06 3.06-3.06zm5.01 2.744c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 2c2.21 0 4 1.79 4 4s-1.79 4-4 4-4-1.79-4-4 1.79-4 4-4zm-1.5 3.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5zm3 0c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5z"/>' }
                };
                
                const icon = icons[platform.toLowerCase()];
                if (!icon) return '';
                
                return `<a href="${url}" target="_blank" rel="noopener noreferrer" title="${platform.charAt(0).toUpperCase() + platform.slice(1)}" style="display: inline-block; width: 24px; height: 24px; background: ${icon.color}; border-radius: 4px; text-align: center; line-height: 24px; text-decoration: none; transition: opacity 0.2s;"><svg width="16" height="16" viewBox="0 0 24 24" fill="white" style="vertical-align: middle;">${icon.svg}</svg></a>`;
            }
            
            membersList.innerHTML = members.map((member) => {
                const avatar = member.avatar_url || 'https://via.placeholder.com/50x50/cccccc/cccccc';
                const socialLinks = [];
                
                if (member.linkedin_url) socialLinks.push(getSocialMediaIcon('linkedin', member.linkedin_url));
                if (member.twitter_url) socialLinks.push(getSocialMediaIcon('twitter', member.twitter_url));
                if (member.facebook_url) socialLinks.push(getSocialMediaIcon('facebook', member.facebook_url));
                if (member.instagram_url) socialLinks.push(getSocialMediaIcon('instagram', member.instagram_url));
                if (member.tiktok_url) socialLinks.push(getSocialMediaIcon('tiktok', member.tiktok_url));
                if (member.threads_url) socialLinks.push(getSocialMediaIcon('threads', member.threads_url));
                if (member.youtube_url) socialLinks.push(getSocialMediaIcon('youtube', member.youtube_url));
                if (member.reddit_url) socialLinks.push(getSocialMediaIcon('reddit', member.reddit_url));
                
                return `
                    <tr style="border-bottom: 1px solid var(--border);" data-member-id="${member.id}">
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;">
                            <img src="${avatar}" alt="Avatar" style="width: 50px; height: 50px; border-radius: 0; object-fit: cover; border: none;">
                        </td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle; font-weight: 600; color: var(--primary);">${member.name || 'No Name'}</td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;">${member.title || 'N/A'}</td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;">${member.organization || 'N/A'}</td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;">${member.website ? `<a href="${member.website}" target="_blank" rel="noopener noreferrer" style="color: var(--primary); text-decoration: none;">${member.website.replace(/^https?:\/\//, '')}</a>` : 'N/A'}</td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;">
                            ${socialLinks.length > 0 ? `<div style="display: flex; align-items: center; gap: 5px;">${socialLinks.join('')}</div>` : 'N/A'}
                        </td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle; white-space: nowrap;">
                            <div style="display: flex; align-items: center; gap: 5px; justify-content: center; flex-wrap: nowrap;">
                                <button class="btn-small btn-edit" onclick="editDirectoryEntry('members', '${member.id}')" style="margin: 0; padding: 6px 12px; font-size: 0.85rem; white-space: nowrap;">Edit</button>
                                <button class="btn-small btn-delete" onclick="deleteDirectoryEntry('members', '${member.id}')" style="margin: 0; padding: 6px 12px; font-size: 0.85rem; white-space: nowrap;">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Render pagination
            if (paginationDiv && pagination.pages > 1) {
                let paginationHTML = '<div style="display: flex; align-items: center; gap: 10px;">';
                if (pagination.has_prev) {
                    paginationHTML += `<button class="btn-small btn-edit" onclick="loadMembersDirectory(${currentDirMemberPage - 1})" style="padding: 8px 15px;">Previous</button>`;
                } else {
                    paginationHTML += `<button class="btn-small" disabled style="padding: 8px 15px; opacity: 0.5; cursor: not-allowed;">Previous</button>`;
                }
                paginationHTML += `<span style="padding: 0 15px;">Page ${pagination.page} of ${pagination.pages} (${pagination.total} total)</span>`;
                if (pagination.has_next) {
                    paginationHTML += `<button class="btn-small btn-edit" onclick="loadMembersDirectory(${currentDirMemberPage + 1})" style="padding: 8px 15px;">Next</button>`;
                } else {
                    paginationHTML += `<button class="btn-small" disabled style="padding: 8px 15px; opacity: 0.5; cursor: not-allowed;">Next</button>`;
                }
                paginationHTML += '</div>';
                paginationDiv.innerHTML = paginationHTML;
            } else if (paginationDiv) {
                paginationDiv.innerHTML = '';
            }
        } catch (error) {
            console.error('Error loading members directory:', error);
            membersList.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--live);">Error loading members. Please try again.</td></tr>';
        }
    }
    
    function changeDirMemberPageSize() {
        const pageSizeSelect = document.getElementById('dirMemberPageSize');
        if (pageSizeSelect) {
            dirMemberPerPage = parseInt(pageSizeSelect.value) || 100;
        }
        loadMembersDirectory(1);
    }
    
    async function loadPartnersDirectory(page = 1) {
        const partnersList = document.getElementById('partnersList');
        const noPartnersMessage = document.getElementById('noPartnersMessage');
        const paginationDiv = document.getElementById('dirPartnerPagination');
        
        if (!partnersList) return;
        
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            partnersList.innerHTML = '';
            if (noPartnersMessage) {
                noPartnersMessage.style.display = 'block';
            }
            return;
        }
        
        // Show loading state
        partnersList.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-light);">Loading partners...</td></tr>';
        
        try {
            const response = await fetch(`/api/admin/directories/partners?page=${page}&limit=${dirPartnerPerPage}`, {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = 'admin-login.html';
                    return;
                }
                throw new Error('Failed to load partners');
            }
            
            const data = await response.json();
            const partners = data.entries || [];
            const pagination = data.pagination || { page: 1, pages: 1, total: 0 };
            
            if (partners.length === 0) {
                partnersList.innerHTML = '';
                if (noPartnersMessage) {
                    noPartnersMessage.style.display = 'block';
                }
                if (paginationDiv) paginationDiv.innerHTML = '';
                return;
            }
            
            if (noPartnersMessage) {
                noPartnersMessage.style.display = 'none';
            }
            currentDirPartnerPage = pagination.page || page;
            
            partnersList.innerHTML = partners.map((partner) => `
                <tr style="border-bottom: 1px solid var(--border);" data-partner-id="${partner.id}">
                    <td style="padding: 10px 8px; border: none; vertical-align: middle;">${partner.address || 'N/A'}</td>
                    <td style="padding: 10px 8px; border: none; vertical-align: middle;">${partner.email ? `<a href="mailto:${partner.email}">${partner.email}</a>` : 'N/A'}</td>
                    <td style="padding: 10px 8px; border: none; vertical-align: middle;">${partner.phone || 'N/A'}</td>
                    <td style="padding: 10px 8px; border: none; vertical-align: middle;">${partner.website ? `<a href="${partner.website}" target="_blank" rel="noopener noreferrer" style="color: var(--primary); text-decoration: none;">${partner.website.replace(/^https?:\/\//, '')}</a>` : 'N/A'}</td>
                    <td style="padding: 10px 8px; border: none; vertical-align: middle; white-space: nowrap;">
                        <div style="display: flex; align-items: center; gap: 5px; justify-content: center; flex-wrap: nowrap;">
                            <button class="btn-small btn-edit" onclick="editDirectoryEntry('partners', '${partner.id}')" style="margin: 0; padding: 6px 12px; font-size: 0.85rem; white-space: nowrap;">Edit</button>
                            <button class="btn-small btn-delete" onclick="deleteDirectoryEntry('partners', '${partner.id}')" style="margin: 0; padding: 6px 12px; font-size: 0.85rem; white-space: nowrap;">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // Render pagination
            if (paginationDiv && pagination.pages > 1) {
                let paginationHTML = '<div style="display: flex; align-items: center; gap: 10px;">';
                if (pagination.has_prev) {
                    paginationHTML += `<button class="btn-small btn-edit" onclick="loadPartnersDirectory(${currentDirPartnerPage - 1})" style="padding: 8px 15px;">Previous</button>`;
                } else {
                    paginationHTML += `<button class="btn-small" disabled style="padding: 8px 15px; opacity: 0.5; cursor: not-allowed;">Previous</button>`;
                }
                paginationHTML += `<span style="padding: 0 15px;">Page ${pagination.page} of ${pagination.pages} (${pagination.total} total)</span>`;
                if (pagination.has_next) {
                    paginationHTML += `<button class="btn-small btn-edit" onclick="loadPartnersDirectory(${currentDirPartnerPage + 1})" style="padding: 8px 15px;">Next</button>`;
                } else {
                    paginationHTML += `<button class="btn-small" disabled style="padding: 8px 15px; opacity: 0.5; cursor: not-allowed;">Next</button>`;
                }
                paginationHTML += '</div>';
                paginationDiv.innerHTML = paginationHTML;
            } else if (paginationDiv) {
                paginationDiv.innerHTML = '';
            }
        } catch (error) {
            console.error('Error loading partners directory:', error);
            partnersList.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--live);">Error loading partners. Please try again.</td></tr>';
        }
    }
    
    function changeDirPartnerPageSize() {
        const pageSizeSelect = document.getElementById('dirPartnerPageSize');
        if (pageSizeSelect) {
            dirPartnerPerPage = parseInt(pageSizeSelect.value) || 100;
        }
        loadPartnersDirectory(1);
    }
    
    function editDirectoryEntry(type, entryId) {
        showDirectoryForm(type, entryId);
    }
    
    async function deleteDirectoryEntry(type, entryId) {
        if (!confirm('Are you sure you want to delete this entry?')) {
            return;
        }
        
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Authentication required. Please log in again.');
            window.location.href = 'admin-login.html';
            return;
        }
        
        try {
            const response = await fetch(`/api/admin/directories/${type}/${entryId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to delete entry');
            }
            
            // Reload the appropriate directory
            if (type === 'members') {
                loadMembersDirectory(currentDirMemberPage);
            } else if (type === 'partners') {
                loadPartnersDirectory(currentDirPartnerPage);
            } else if (type === 'business') {
                loadBusinessDirectory(currentDirBusinessPage);
            }
            
            updateOverviewStats(); // Update stats after directory deletion
            alert('Entry deleted successfully!');
        } catch (error) {
            console.error('Error deleting directory entry:', error);
            alert('Error: ' + error.message);
        }
    }
    
    async function populateDirectoryForm(type, entryId) {
        if (!entryId) return;
        
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            console.error('No admin token found for populating form');
            return;
        }
        
        try {
            if (type === 'members') {
                // Fetch full member data from API
                const response = await fetch(`/api/admin/directories/members?limit=1000`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch member details');
                }
                
                const data = await response.json();
                const entry = data.entries?.find(e => e.id === parseInt(entryId));
                
                if (!entry) {
                    console.error('Member not found');
                    return;
                }
                
                document.getElementById('dirName').value = entry.name || '';
                document.getElementById('dirTitle').value = entry.title || '';
                document.getElementById('dirOrg').value = entry.organization || '';
                document.getElementById('dirWebsite').value = entry.website || '';
                document.getElementById('dirLinkedIn').value = entry.linkedin_url || '';
                document.getElementById('dirTwitter').value = entry.twitter_url || '';
                if (document.getElementById('dirFacebook')) document.getElementById('dirFacebook').value = entry.facebook_url || '';
                if (document.getElementById('dirInstagram')) document.getElementById('dirInstagram').value = entry.instagram_url || '';
                if (document.getElementById('dirTikTok')) document.getElementById('dirTikTok').value = entry.tiktok_url || '';
                if (document.getElementById('dirThreads')) document.getElementById('dirThreads').value = entry.threads_url || '';
                if (document.getElementById('dirYouTube')) document.getElementById('dirYouTube').value = entry.youtube_url || '';
                if (document.getElementById('dirReddit')) document.getElementById('dirReddit').value = entry.reddit_url || '';
                
                if (entry.avatar_url) {
                    const preview = document.getElementById('memberAvatarPreview');
                    const placeholder = document.getElementById('memberAvatarPlaceholder');
                    if (preview) {
                        preview.src = entry.avatar_url;
                        preview.style.display = 'block';
                    }
                    if (placeholder) {
                        placeholder.style.display = 'none';
                    }
                }
            } else if (type === 'partners') {
                // Fetch partner data from API
                const response = await fetch(`/api/admin/directories/partners?limit=1000`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch partner details');
                }
                
                const data = await response.json();
                const entry = data.entries?.find(e => e.id === parseInt(entryId));
                
                if (!entry) {
                    console.error('Partner not found');
                    return;
                }
                
                document.getElementById('dirAddress').value = entry.address || '';
                document.getElementById('dirEmail').value = entry.email || '';
                document.getElementById('dirPhone').value = entry.phone || '';
                document.getElementById('dirWebsite').value = entry.website || '';
            }
        } catch (error) {
            console.error('Error populating directory form:', error);
            alert('Error loading entry details: ' + error.message);
        }
    }

    function saveHomepageContent(e, section) {
        e.preventDefault();
        if (section === 'hero') {
            alert('Hero section content saved successfully!');
        } else if (section === 'intro') {
            alert('Introduction section content saved successfully!');
        } else if (section === 'about') {
            alert('About Us & Vision content saved successfully!');
        }
    }
    
    function saveToolsSettings(e, type) {
        e.preventDefault();
        if (type === 'exchange') {
            const ngnToUsd = document.getElementById('ngnToUsd').value;
            const ngnToGbp = document.getElementById('ngnToGbp').value;
            localStorage.setItem('exchangeRates', JSON.stringify({ usd: ngnToUsd, gbp: ngnToGbp }));
            alert('Exchange rates saved successfully!');
        } else if (type === 'defaults') {
            const defaults = {
                loanRate: document.getElementById('loanRate').value,
                loanTerm: document.getElementById('loanTerm').value,
                mortgageRate: document.getElementById('mortgageRate').value,
                mortgageTerm: document.getElementById('mortgageTerm').value,
                taxRate: document.getElementById('taxRate').value
            };
            localStorage.setItem('calculatorDefaults', JSON.stringify(defaults));
            alert('Calculator default values saved successfully!');
        }
    }

    // Tool Visibility Management Functions - Using API
    async function loadToolVisibility() {
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            console.warn('No admin token - cannot load tool visibility');
            return;
        }
        
        try {
            // Load built-in tools from API
            const toolsResponse = await fetch('/api/tools/builtin');
            let builtinTools = [];
            if (toolsResponse.ok) {
                const toolsData = await toolsResponse.json();
                builtinTools = toolsData.tools || [];
            } else {
                // Fallback to hardcoded list if API fails
                builtinTools = [
                    { tool_id: 'savings', name: 'Savings Target Calculator', description: 'Calculate monthly savings needed to reach financial goals' },
                    { tool_id: 'loan', name: 'Business Loan Calculator', description: 'Calculate monthly loan repayments' },
                    { tool_id: 'mortgage', name: 'Mortgage Calculator', description: 'Calculate mortgage payments for property purchases' },
                    { tool_id: 'pit', name: 'PIT Calculator (Nigeria)', description: 'Calculate Personal Income Tax based on Nigeria 2026 tax law' },
                    { tool_id: 'cit', name: 'CIT Calculator (Nigeria)', description: 'Calculate Company Income Tax based on Nigeria 2026 tax law' },
                    { tool_id: 'breakeven', name: 'Break-Even Calculator', description: 'Calculate break-even point for pricing decisions' },
                    { tool_id: 'cashflow', name: 'Cash Flow Forecast', description: 'Project monthly cash inflows and outflows' },
                    { tool_id: 'profitmargin', name: 'Profit Margin Calculator', description: 'Calculate gross, operating, and net profit margins' },
                    { tool_id: 'payroll', name: 'Payroll Calculator (Nigeria)', description: 'Calculate employee salaries with Nigerian deductions' },
                    { tool_id: 'roi', name: 'ROI Calculator', description: 'Calculate Return on Investment for decision making' }
                ];
            }
            
            // Load visibility settings from API
            const visResponse = await fetch('/api/tools/visibility');
            let visibilitySettings = {};
            if (visResponse.ok) {
                const visData = await visResponse.json();
                visibilitySettings = visData.visibility || {};
            }
        
            // Load built-in tools visibility
            const builtinList = document.getElementById('builtinToolsList');
            if (builtinList) {
                builtinList.innerHTML = builtinTools.map(tool => {
                    const toolId = tool.tool_id || tool.id;
                    const isVisible = visibilitySettings[toolId] !== false; // Default to true
                return `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: ${isVisible ? '#f0fff4' : '#fff5f5'}; border: 1px solid ${isVisible ? '#c6f6d5' : '#feb2b2'}; border-radius: 8px;">
                        <div style="flex: 1;">
                            <strong style="color: var(--primary); display: block; margin-bottom: 5px;">${tool.name}</strong>
                            <small style="color: var(--text-light);">${tool.description}</small>
                        </div>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-left: 20px;">
                            <span style="color: ${isVisible ? 'var(--success)' : 'var(--text-light)'}; font-weight: 600; font-size: 0.9rem;">
                                ${isVisible ? 'Visible' : 'Hidden'}
                            </span>
                            <div style="position: relative; width: 50px; height: 26px;">
                                <input type="checkbox" 
                                       ${isVisible ? 'checked' : ''} 
                                       onchange="toggleToolVisibility('${toolId}', this.checked, 'builtin')"
                                       style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${isVisible ? 'var(--success)' : '#cbd5e0'}; border-radius: 26px; transition: background-color 0.3s;">
                                    <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: transform 0.3s; transform: ${isVisible ? 'translateX(24px)' : 'translateX(0)'};"></span>
                                </span>
                            </div>
                        </label>
                    </div>
                `;
                }).join('');
            }
            
            // Load custom tools visibility
            const customList = document.getElementById('customToolsVisibilityList');
            if (customList) {
                // Load custom tools from API
                try {
                    const customToolsResponse = await fetch('/api/tools/custom', {
                        headers: {
                            'Authorization': `Bearer ${adminToken}`
                        }
                    });
                    
                    let customTools = [];
                    if (customToolsResponse.ok) {
                        const customToolsData = await customToolsResponse.json();
                        customTools = customToolsData.tools || [];
                    }
                    
                    if (customTools.length === 0) {
                        customList.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px;">No custom tools created yet.</p>';
                    } else {
                        customList.innerHTML = customTools.map(tool => {
                            const toolId = tool.id.toString();
                            const isVisible = visibilitySettings[toolId] !== false; // Default to true
                            return `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: ${isVisible ? '#f0fff4' : '#fff5f5'}; border: 1px solid ${isVisible ? '#c6f6d5' : '#feb2b2'}; border-radius: 8px;">
                                    <div style="flex: 1;">
                                        <strong style="color: var(--primary); display: block; margin-bottom: 5px;">${tool.name}</strong>
                                        <small style="color: var(--text-light);">${tool.description || 'Custom tool'}</small>
                                    </div>
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-left: 20px;">
                                        <span style="color: ${isVisible ? 'var(--success)' : 'var(--text-light)'}; font-weight: 600; font-size: 0.9rem;">
                                            ${isVisible ? 'Visible' : 'Hidden'}
                                        </span>
                                        <div style="position: relative; width: 50px; height: 26px;">
                                            <input type="checkbox" 
                                                   ${isVisible ? 'checked' : ''} 
                                                   onchange="toggleToolVisibility('${toolId}', this.checked, 'custom')"
                                                   style="opacity: 0; width: 0; height: 0;">
                                            <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${isVisible ? 'var(--success)' : '#cbd5e0'}; border-radius: 26px; transition: background-color 0.3s;">
                                                <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: transform 0.3s; transform: ${isVisible ? 'translateX(24px)' : 'translateX(0)'};"></span>
                                            </span>
                                        </div>
                                    </label>
                                </div>
                            `;
                        }).join('');
                    }
                } catch (customError) {
                    console.error('Error loading custom tools:', customError);
                    customList.innerHTML = '<p style="text-align: center; color: var(--error); padding: 20px;">Error loading custom tools.</p>';
                }
            }
        } catch (error) {
            console.error('Error loading tool visibility:', error);
        }
    }
    
    // Toggle tool visibility function
    async function toggleToolVisibility(toolId, isVisible, type) {
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Please log in to change tool visibility');
            return;
        }
        
        try {
            // Update via API
            const response = await fetch(`/api/admin/tools/${toolId}/visibility`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ is_visible: isVisible })
            });
            
            if (!response.ok) {
                throw new Error('Failed to update tool visibility');
            }
            
            // Reload to update visual feedback
            await loadToolVisibility();
            
            // Show confirmation
            const status = isVisible ? 'visible' : 'hidden';
            const toolName = type === 'builtin' 
                ? document.querySelector(`#builtinToolsList [onchange*="${toolId}"]`)?.closest('div')?.querySelector('strong')?.textContent
                : document.querySelector(`#customToolsVisibilityList [onchange*="${toolId}"]`)?.closest('div')?.querySelector('strong')?.textContent;
            
            const message = `Tool "${toolName || toolId}" is now ${status}. Users will see this change immediately.`;
            console.log(message);
            
            // Show brief notification
            const notification = document.createElement('div');
            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000; font-weight: 600;';
            notification.textContent = `Tool ${status}!`;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        } catch (error) {
            console.error('Error toggling tool visibility:', error);
            alert('Error updating tool visibility: ' + error.message);
        }
    }

    // Tool Management Functions - Using API
    async function loadTools() {
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            console.warn('No admin token - cannot load tools');
            return;
        }
        
        try {
            const response = await fetch('/api/tools/custom', {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to load tools');
            }
            
            const data = await response.json();
            const tools = data.tools || [];
            
            const toolsList = document.getElementById('toolsList');
            if (!toolsList) return;
            
            if (tools.length === 0) {
                toolsList.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">No custom tools found. Click "+ Add New Tool" to create one.</p>';
                return;
            }
            
            toolsList.innerHTML = tools.map(tool => {
                const inputs = typeof tool.inputs === 'string' ? JSON.parse(tool.inputs) : tool.inputs;
                return `
                    <div class="content-item" data-tool-id="${tool.id}">
                        <h4>${tool.name}</h4>
                        <p><strong>Description:</strong> ${tool.description || 'No description'}</p>
                        <p><strong>Input Fields:</strong> ${inputs ? inputs.length : 0}</p>
                        <p><strong>Result Label:</strong> ${tool.result_label || 'N/A'}</p>
                        <div class="content-actions">
                            <button class="btn-small btn-edit" onclick="editTool('${tool.id}')">Edit</button>
                            <button class="btn-small btn-delete" onclick="deleteTool('${tool.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading tools:', error);
            const toolsList = document.getElementById('toolsList');
            if (toolsList) {
                toolsList.innerHTML = '<p style="text-align: center; color: var(--error); padding: 40px;">Error loading tools. Please try again.</p>';
            }
        }
    }

    function showToolForm(toolId = null) {
        const form = document.getElementById('toolForm');
        const formTitle = document.getElementById('toolFormTitle');
        const saveBtn = document.getElementById('toolSaveBtn');
        
        // Reset form
        document.getElementById('toolId').value = toolId || '';
        document.getElementById('toolName').value = '';
        document.getElementById('toolDescription').value = '';
        document.getElementById('toolFunction').value = '';
        document.getElementById('toolInputs').value = '';
        document.getElementById('toolResultLabel').value = '';
        document.getElementById('toolResultId').value = '';
        document.getElementById('toolButtonText').value = 'Calculate';
        document.getElementById('toolButtonColor').value = 'var(--primary)';
        document.getElementById('toolShowConversion').value = 'true';
        document.getElementById('toolResultColor').value = 'default';
        
        if (toolId) {
            // Load existing tool from API
            const adminToken = sessionStorage.getItem('adminToken');
            if (adminToken) {
                fetch(`/api/admin/tools/${toolId}`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.tool) {
                        const tool = data.tool;
                        document.getElementById('toolId').value = tool.id;
                        document.getElementById('toolName').value = tool.name || '';
                        document.getElementById('toolDescription').value = tool.description || '';
                        document.getElementById('toolFunction').value = tool.function_code || '';
                        const inputs = typeof tool.inputs === 'string' ? JSON.parse(tool.inputs) : tool.inputs;
                        document.getElementById('toolInputs').value = JSON.stringify(inputs || [], null, 2);
                        document.getElementById('toolResultLabel').value = tool.result_label || '';
                        document.getElementById('toolResultId').value = tool.result_id || '';
                        document.getElementById('toolButtonText').value = tool.button_text || 'Calculate';
                        document.getElementById('toolButtonColor').value = tool.button_color || 'var(--primary)';
                        document.getElementById('toolShowConversion').value = tool.show_conversion ? 'true' : 'false';
                        document.getElementById('toolResultColor').value = tool.result_color || 'default';
                    }
                })
                .catch(error => {
                    console.error('Error loading tool:', error);
                    alert('Error loading tool. Please try again.');
                });
            }
            formTitle.textContent = 'Edit Tool';
            saveBtn.textContent = 'Update Tool';
        } else {
            formTitle.textContent = 'Add New Tool';
            saveBtn.textContent = 'Save Tool';
        }
        
        form.style.display = 'block';
        form.scrollIntoView({ behavior: 'smooth' });
    }

    function hideToolForm() {
        document.getElementById('toolForm').style.display = 'none';
    }

    async function saveTool(e) {
        e.preventDefault();
        
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Please log in to save tools.');
            return;
        }
        
        const toolId = document.getElementById('toolId').value;
        const name = document.getElementById('toolName').value;
        const description = document.getElementById('toolDescription').value;
        const func = document.getElementById('toolFunction').value;
        let inputs;
        try {
            inputs = JSON.parse(document.getElementById('toolInputs').value);
        } catch (error) {
            alert('Invalid JSON in Input Fields. Please check your format.');
            return;
        }
        const resultLabel = document.getElementById('toolResultLabel').value;
        const resultId = document.getElementById('toolResultId').value;
        const buttonText = document.getElementById('toolButtonText').value;
        const buttonColor = document.getElementById('toolButtonColor').value;
        const showConversion = document.getElementById('toolShowConversion').value === 'true';
        const resultColor = document.getElementById('toolResultColor').value;
        
        // Prepare data for API (match server.js endpoint format)
        const toolData = {
            name: name,
            description: description || null,
            inputs: inputs,
            function_code: func,
            result_label: resultLabel,
            result_id: resultId,
            button_text: buttonText || 'Calculate',
            button_color: buttonColor || '#1a365d',
            result_color: resultColor || 'default',
            show_conversion: showConversion || false
        };
        
        try {
            const url = toolId ? `/api/admin/tools/${toolId}` : '/api/admin/tools';
            const method = toolId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(toolData)
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message || 'Failed to save tool');
            }
            
            alert(toolId ? 'Tool updated successfully!' : 'Tool created successfully!');
            await loadTools();
            await loadToolVisibility(); // Reload visibility list when tools change
            hideToolForm();
        } catch (error) {
            console.error('Error saving tool:', error);
            alert('Error saving tool: ' + error.message);
        }
    }

    function editTool(toolId) {
        showToolForm(toolId);
    }

    async function deleteTool(toolId) {
        if (!confirm('Are you sure you want to delete this tool?')) {
            return;
        }
        
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Please log in to delete tools');
            return;
        }
        
        try {
            const response = await fetch(`/api/admin/tools/${toolId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to delete tool');
            }
            
            alert('Tool deleted successfully!');
            await loadTools();
            await loadToolVisibility(); // Reload visibility list when tools are deleted
        } catch (error) {
            console.error('Error deleting tool:', error);
            alert('Error deleting tool: ' + error.message);
        }
    }

    // Template Download Statistics Functions - Using API
    async function loadTemplateStats() {
        const templateList = document.getElementById('templateStatsList');
        if (!templateList) return;

        try {
            const token = sessionStorage.getItem('adminToken');
            if (!token) {
                templateList.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--text-light);">Please log in to view template statistics.</td></tr>';
                return;
            }

            const response = await fetch('/api/admin/templates/stats', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load template statistics');
            }

            const data = await response.json();
            const stats = data.stats || [];
            const totalDownloads = data.total_downloads || 0;

            if (stats.length === 0) {
                templateList.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--text-light);">No template statistics available.</td></tr>';
                return;
            }
            
            // Update colspan for error messages
            const errorColspan = 4;

            templateList.innerHTML = stats.map(template => {
                const count = parseInt(template.download_count) || 0;
                // Properly check is_active: MySQL returns 0/1, JavaScript boolean, or undefined
                // is_active === 1 or is_active === true means active, everything else (0, false, undefined) means inactive
                const isActive = template.is_active === 1 || template.is_active === true;
                const statusStyle = isActive ? '' : 'opacity: 0.6; text-decoration: line-through;';
                const templateNameEscaped = (template.name || template.template_id).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                // Hide button: red when hidden (isActive = false), blue (accent color #2b6cb0) when visible (isActive = true)
                const hideButtonColor = isActive ? '#2b6cb0' : '#e53e3e';
                const hideButtonText = isActive ? 'Hide' : 'Show';
                return `
                    <tr style="${statusStyle}">
                        <td style="padding: 12px 8px; border-bottom: 1px solid var(--border); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${template.name || template.template_id}">${template.name || template.template_id}</td>
                        <td style="padding: 12px 8px; border-bottom: 1px solid var(--border); color: var(--text-light); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${template.category || 'N/A'}</td>
                        <td style="padding: 12px 8px; border-bottom: 1px solid var(--border); text-align: center; font-weight: bold; color: var(--primary);">${count}</td>
                        <td style="padding: 8px 4px; border-bottom: 1px solid var(--border); text-align: center; white-space: nowrap;">
                            <button onclick="toggleTemplateVisibility('${template.template_id}', ${!isActive})" class="btn-small" style="padding: 4px 8px; font-size: 0.7rem; margin: 0 1px; background: ${hideButtonColor}; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; min-width: 50px;">${hideButtonText}</button>
                            <button onclick="resetTemplateCount('${template.template_id}')" class="btn-small" style="padding: 4px 8px; font-size: 0.7rem; margin: 0 1px; background: #2b6cb0; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; min-width: 50px;">Reset</button>
                            <button onclick="deleteTemplate('${template.template_id}', '${templateNameEscaped}')" class="btn-small" style="padding: 4px 8px; font-size: 0.7rem; margin: 0 1px; background: #2b6cb0; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; min-width: 50px;">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');

            const totalElement = document.getElementById('templateTotalDownloads');
            if (totalElement) {
                totalElement.textContent = totalDownloads;
            }
        } catch (error) {
            console.error('Error loading template stats:', error);
            templateList.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--error);">Error loading template statistics. Please try again.</td></tr>';
            const totalElement = document.getElementById('templateTotalDownloads');
            if (totalElement) {
                totalElement.textContent = '0';
            }
        }
    }

    async function refreshTemplateStats() {
        await loadTemplateStats();
        alert('Template statistics refreshed!');
    }

    async function resetTemplateStats() {
        if (!confirm('Are you sure you want to reset ALL template download counts? This will delete all download records from the database. This cannot be undone.')) {
            return;
        }
        
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Please log in to reset template counts.');
            return;
        }
        
        try {
            const response = await fetch('/api/admin/templates/downloads', {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to reset all template counts');
            }
            
            // Reload stats to show updated counts
            await loadTemplateStats();
            alert('All template download counts reset successfully!');
        } catch (error) {
            console.error('Error resetting all template counts:', error);
            alert('Error resetting template counts: ' + error.message);
        }
    }
    
    async function resetTemplateCount(templateId) {
        if (!confirm('Are you sure you want to reset the download count for this template? This will delete all download records for this template from the database.')) {
            return;
        }
        
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Please log in to reset template counts.');
            return;
        }
        
        try {
            const response = await fetch(`/api/admin/templates/${templateId}/downloads`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to reset template count');
            }
            
            // Reload stats to show updated counts
            await loadTemplateStats();
            alert('Template download count reset successfully!');
        } catch (error) {
            console.error('Error resetting template count:', error);
            alert('Error resetting template count: ' + error.message);
        }
    }
    
    async function toggleTemplateVisibility(templateId, isActive) {
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Please log in to manage templates.');
            return;
        }
        
        try {
            const response = await fetch(`/api/admin/templates/${templateId}/visibility`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ is_active: isActive })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to update template visibility');
            }
            
            // Reload stats to show updated status (button color will change)
            await loadTemplateStats();
            
            // Show success message
            alert(`Template ${isActive ? 'shown' : 'hidden'} successfully! The change will be visible on the templates page immediately.`);
        } catch (error) {
            console.error('Error toggling template visibility:', error);
            alert('Error updating template visibility: ' + error.message);
        }
    }
    
    async function deleteTemplate(templateId, templateName) {
        if (!confirm(`Are you sure you want to delete "${templateName}"? This will permanently delete the template and all its download records. This cannot be undone.`)) {
            return;
        }
        
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Please log in to delete templates.');
            return;
        }
        
        try {
            const response = await fetch(`/api/admin/templates/${templateId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to delete template');
            }
            
            // Reload stats to show updated list
            await loadTemplateStats();
            alert('Template deleted successfully!');
        } catch (error) {
            console.error('Error deleting template:', error);
            alert('Error deleting template: ' + error.message);
        }
    }

    // Logout function
    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            sessionStorage.removeItem('adminAuthenticated');
            sessionStorage.removeItem('adminToken');
            sessionStorage.removeItem('adminUsername');
            sessionStorage.removeItem('adminId');
            window.location.href = 'admin-login.html';
        }
    }

    // Set welcome message with username on page load
    window.addEventListener('DOMContentLoaded', function() {
        const username = sessionStorage.getItem('adminUsername') || 'Admin';
        const welcomeElement = document.getElementById('welcomeMessage');
        if (welcomeElement) {
            welcomeElement.textContent = 'Welcome, ' + username;
        }
        
        // Initialize directory tabs - show business directory by default
        showDirectoryTab('business');
        
        // Initialize directory page sizes
        const dirBusinessPageSize = document.getElementById('dirBusinessPageSize');
        if (dirBusinessPageSize) {
            dirBusinessPerPage = parseInt(dirBusinessPageSize.value) || 100;
        }
        const dirMemberPageSize = document.getElementById('dirMemberPageSize');
        if (dirMemberPageSize) {
            dirMemberPerPage = parseInt(dirMemberPageSize.value) || 100;
        }
        const dirPartnerPageSize = document.getElementById('dirPartnerPageSize');
        if (dirPartnerPageSize) {
            dirPartnerPerPage = parseInt(dirPartnerPageSize.value) || 100;
        }
        
        // Update overview stats with actual counts
        updateOverviewStats();
        
        // Load data if sections are active
        const usersSection = document.getElementById('users');
        if (usersSection && usersSection.classList.contains('active')) {
            loadUsers();
        }
        const membersSection = document.getElementById('members');
        if (membersSection && membersSection.classList.contains('active')) {
            loadMembers();
        }
    });
    
    // ========== USERS MANAGEMENT ==========
    let currentUsersPage = 1;
    let usersPerPage = 100;
    
    async function loadUsers(page = 1) {
        const usersList = document.getElementById('usersList');
        const noUsersMessage = document.getElementById('noUsersMessage');
        const paginationDiv = document.getElementById('usersPagination');
        
        console.log('=== loadUsers called ===', 'page:', page);
        
        if (!usersList) {
            console.error('usersList element not found!');
            return;
        }
        
        // Get page size from selector
        const pageSizeSelect = document.getElementById('userPageSize');
        if (pageSizeSelect) {
            usersPerPage = parseInt(pageSizeSelect.value) || 100;
        }
        
        // Get admin token
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            console.error('No admin token found!');
            if (noUsersMessage) {
                noUsersMessage.style.display = 'block';
                noUsersMessage.textContent = 'Authentication required. Please log in again.';
            }
            return;
        }
        
        // Show loading state
        usersList.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--text-light);">Loading users...</td></tr>';
        if (paginationDiv) paginationDiv.innerHTML = '';
        
        try {
            // Build URL with pagination
            const url = `/api/admin/users?page=${page}&limit=${usersPerPage}`;
            
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    sessionStorage.removeItem('adminToken');
                    sessionStorage.removeItem('adminAuthenticated');
                    window.location.href = 'admin-login.html';
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            const users = data.users || [];
            const pagination = data.pagination || {};
            
            console.log('Users from API:', users);
            console.log('Pagination info:', pagination);
            
            // Get search term for filtering (client-side for current page)
            const searchTerm = document.getElementById('userSearch')?.value.toLowerCase() || '';
            let filteredUsers = users;
            if (searchTerm) {
                filteredUsers = users.filter(user => {
                    const name = (user.name || '').toLowerCase();
                    const email = (user.email || '').toLowerCase();
                    return name.includes(searchTerm) || email.includes(searchTerm);
                });
            }
            
            // Sort users
            const sortBy = document.getElementById('userSort')?.value || 'newest';
            filteredUsers.sort((a, b) => {
                if (sortBy === 'newest') {
                    const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
                    const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
                    return dateB - dateA;
                } else if (sortBy === 'oldest') {
                    const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
                    const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
                    return dateA - dateB;
                } else if (sortBy === 'name') {
                    return (a.name || '').localeCompare(b.name || '');
                } else if (sortBy === 'email') {
                    return (a.email || '').localeCompare(b.email || '');
                }
                return 0;
            });
            
            if (filteredUsers.length === 0) {
                usersList.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-light);">${searchTerm ? 'No users match your search.' : 'No registered users found.'}</td></tr>`;
                if (noUsersMessage) noUsersMessage.style.display = 'none';
                if (paginationDiv) paginationDiv.innerHTML = '';
                return;
            }
            
            if (noUsersMessage) noUsersMessage.style.display = 'none';
            
            // Update current page
            currentUsersPage = pagination.page || page;
            
            // Render users in table format
            usersList.innerHTML = filteredUsers.map(user => {
                let regDate = 'N/A';
                if (user.created_at) {
                    try {
                        regDate = new Date(user.created_at).toLocaleDateString();
                    } catch (e) {
                        regDate = user.created_at;
                    }
                }
                const uuid = user.uuid || 'N/A';
                return `
                    <tr style="border-bottom: 1px solid var(--border);" data-user-id="${user.id}">
                        <td style="padding: 10px 8px; border: none; vertical-align: middle; font-weight: 600; color: var(--primary);">${user.name || 'No Name'}</td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;">${user.email}</td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;">${user.phone || 'Not provided'}</td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;"><code style="background: var(--light); padding: 2px 6px; border-radius: 3px; font-size: 0.85rem;">${uuid}</code></td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;">${regDate}</td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;"><span style="color: ${user.is_active ? 'var(--success)' : 'var(--live)'};">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle; white-space: nowrap;">
                            <div style="display: flex; align-items: center; gap: 5px; justify-content: center;">
                                <button class="btn-small btn-edit" onclick="editUser(${user.id}, '${user.email}', '${(user.name || '').replace(/'/g, "\\'")}', '${(user.phone || '').replace(/'/g, "\\'")}')" style="margin: 0;">Edit</button>
                                <button class="btn-small btn-delete" onclick="deleteUser(${user.id}, '${user.email}')" style="margin: 0;">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Add hover effect
            const rows = usersList.querySelectorAll('tr');
            rows.forEach(row => {
                row.style.cursor = 'pointer';
                row.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = 'var(--light)';
                });
                row.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });
            });
            
            // Render pagination
            if (paginationDiv && pagination.pages > 1) {
                let paginationHTML = '<div style="display: flex; align-items: center; gap: 10px;">';
                if (pagination.has_prev) {
                    paginationHTML += `<button class="btn-small btn-edit" onclick="loadUsers(${currentUsersPage - 1})" style="padding: 8px 15px;">Previous</button>`;
                } else {
                    paginationHTML += `<button class="btn-small" disabled style="padding: 8px 15px; opacity: 0.5; cursor: not-allowed;">Previous</button>`;
                }
                paginationHTML += `<span style="padding: 0 15px;">Page ${pagination.page} of ${pagination.pages} (${pagination.total} total)</span>`;
                if (pagination.has_next) {
                    paginationHTML += `<button class="btn-small btn-edit" onclick="loadUsers(${currentUsersPage + 1})" style="padding: 8px 15px;">Next</button>`;
                } else {
                    paginationHTML += `<button class="btn-small" disabled style="padding: 8px 15px; opacity: 0.5; cursor: not-allowed;">Next</button>`;
                }
                paginationHTML += '</div>';
                paginationDiv.innerHTML = paginationHTML;
            } else if (paginationDiv) {
                paginationDiv.innerHTML = '';
            }
            
            console.log('Users rendered successfully. Total displayed:', filteredUsers.length);
        } catch (error) {
            console.error('Error loading users:', error);
            usersList.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--live);">Error loading users. Please try again.</td></tr>';
            if (noUsersMessage) noUsersMessage.style.display = 'none';
            if (paginationDiv) paginationDiv.innerHTML = '';
        }
    }
    
    function changeUserPageSize() {
        const pageSizeSelect = document.getElementById('userPageSize');
        if (pageSizeSelect) {
            usersPerPage = parseInt(pageSizeSelect.value) || 100;
        }
        loadUsers(1); // Reset to page 1
    }
    
    function filterUsers() {
        loadUsers(1); // Reset to page 1 when searching
    }
    
    function sortUsers() {
        loadUsers(currentUsersPage); // Keep current page
    }
    
    function refreshUsers() {
        const searchInput = document.getElementById('userSearch');
        if (searchInput) {
            searchInput.value = '';
        }
        loadUsers(1);
    }
    
    async function editUser(userId, userEmail, currentName, currentPhone) {
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Authentication required. Please log in again.');
            window.location.href = 'admin-login.html';
            return;
        }

        try {
            // Show edit form with user email for identification
            const newName = prompt(`Edit User: ${userEmail}\n\nEnter new name:`, currentName || '');
            if (newName === null) return; // User cancelled

            const newPhone = prompt(`Edit User: ${userEmail}\n\nEnter new phone number:`, currentPhone || '');
            if (newPhone === null) return; // User cancelled

            // Update user via API
            const updateResponse = await fetch(`/api/admin/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: newName,
                    phone: newPhone || null
                })
            });

            if (!updateResponse.ok) {
                const errorData = await updateResponse.json();
                throw new Error(errorData.message || 'Failed to update user');
            }

            // Reload users list
            loadUsers();
            alert('User updated successfully!');
        } catch (error) {
            console.error('Error editing user:', error);
            alert(`Error: ${error.message || 'Failed to update user. Please try again.'}`);
        }
    }
    
    async function deleteUser(userId, userEmail) {
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Authentication required. Please log in again.');
            window.location.href = 'admin-login.html';
            return;
        }

        try {
            if (!confirm(`Are you sure you want to delete user "${userEmail}"? This action cannot be undone.`)) {
                return;
            }

            // Delete user via API
            const deleteResponse = await fetch(`/api/admin/users/${userId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });

            if (!deleteResponse.ok) {
                const errorData = await deleteResponse.json();
                throw new Error(errorData.message || 'Failed to delete user');
            }

            // Reload users list and update stats
            loadUsers();
            updateOverviewStats();
            alert('User deleted successfully!');
        } catch (error) {
            console.error('Error deleting user:', error);
            alert(`Error: ${error.message || 'Failed to delete user. Please try again.'}`);
        }
    }
    
    // Update overview stats from API
    async function updateOverviewStats() {
        console.log('=== updateOverviewStats called ===');
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            console.warn('No admin token - cannot fetch stats');
            // Show 0s if no token
            const statEvents = document.getElementById('statEvents');
            const statBlogPosts = document.getElementById('statBlogPosts');
            const statDirectoryEntries = document.getElementById('statDirectoryEntries');
            const statRegisteredUsers = document.getElementById('statRegisteredUsers');
            const statMembers = document.getElementById('statMembers');
            if (statEvents) statEvents.textContent = '0';
            if (statBlogPosts) statBlogPosts.textContent = '0';
            if (statDirectoryEntries) statDirectoryEntries.textContent = '0';
            if (statRegisteredUsers) statRegisteredUsers.textContent = '0';
            if (statMembers) statMembers.textContent = '0';
            return;
        }

        try {
            console.log('Fetching stats from API...');
            const response = await fetch('/api/admin/dashboard/stats', {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });

            console.log('API response status:', response.status);

            if (!response.ok) {
                if (response.status === 401) {
                    // Token expired
                    console.log('Token expired, redirecting to login...');
                    sessionStorage.removeItem('adminToken');
                    sessionStorage.removeItem('adminAuthenticated');
                    window.location.href = 'admin-login.html';
                    return;
                }
                let errorText;
                try {
                    const errorData = await response.json();
                    errorText = errorData.message || errorData.error || JSON.stringify(errorData);
                    console.error('API error response:', errorText);
                    console.error('Error details:', errorData);
                } catch (e) {
                    errorText = await response.text();
                    console.error('API error response (text):', errorText);
                }
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }

            const stats = await response.json();
            console.log('Stats received from API:', stats);
            console.log('Full API response:', JSON.stringify(stats, null, 2));
            
            // Validate that stats object exists and has the expected fields
            if (!stats || typeof stats !== 'object') {
                throw new Error('Invalid stats response format');
            }
            
            console.log('Event stats value:', stats.total_events, 'Type:', typeof stats.total_events);
            
            // Update stat values immediately
            const statEvents = document.getElementById('statEvents');
            const statBlogPosts = document.getElementById('statBlogPosts');
            const statDirectoryEntries = document.getElementById('statDirectoryEntries');
            const statRegisteredUsers = document.getElementById('statRegisteredUsers');
            const statMembers = document.getElementById('statMembers');
            
            console.log('DOM elements check:', {
                statEvents: !!statEvents,
                statBlogPosts: !!statBlogPosts,
                statDirectoryEntries: !!statDirectoryEntries,
                statRegisteredUsers: !!statRegisteredUsers,
                statMembers: !!statMembers
            });
            
            // Map API response to stat elements
            if (statEvents) {
                // Ensure we convert to number and handle null/undefined
                const value = stats.total_events !== undefined && stats.total_events !== null 
                    ? parseInt(stats.total_events, 10) || 0 
                    : 0;
                statEvents.textContent = value;
                console.log(`‚úÖ Updated statEvents to: ${value} (from ${stats.total_events})`);
            } else {
                console.warn('‚ùå statEvents element not found!');
            }
            
            if (statBlogPosts) {
                const value = parseInt(stats.total_blog_posts) || 0;
                statBlogPosts.textContent = value;
                console.log(`‚úÖ Updated statBlogPosts to: ${value}`);
            } else {
                console.warn('‚ùå statBlogPosts element not found!');
            }
            
            if (statDirectoryEntries) {
                const value = parseInt(stats.total_directory_entries) || 0;
                statDirectoryEntries.textContent = value;
                console.log(`‚úÖ Updated statDirectoryEntries to: ${value}`);
            } else {
                console.warn('‚ùå statDirectoryEntries element not found!');
            }
            
            if (statRegisteredUsers) {
                const value = parseInt(stats.total_registered_users) || 0;
                statRegisteredUsers.textContent = value;
                console.log(`‚úÖ Updated statRegisteredUsers to: ${value}`);
            } else {
                console.warn('‚ùå statRegisteredUsers element not found!');
            }
            
            if (statMembers) {
                const value = parseInt(stats.total_members) || 0;
                statMembers.textContent = value;
                console.log(`‚úÖ Updated statMembers to: ${value}`);
            } else {
                console.warn('‚ùå statMembers element not found!');
            }
            
            console.log('‚úÖ Overview stats updated from API');
        } catch (error) {
            console.error('‚ùå Error updating overview stats:', error);
            console.error('Error details:', error.message, error.stack);
            // Show error indicator
            const statEvents = document.getElementById('statEvents');
            if (statEvents) statEvents.textContent = 'Error';
        }
    }

    // ========== MEMBERS MANAGEMENT ==========
    let currentMembersPage = 1;
    let membersPerPage = 30;
    
    async function loadMembers(page = 1) {
        const membersList = document.getElementById('membersList');
        const noMembersMessage = document.getElementById('noMembersMessage');
        const paginationDiv = document.getElementById('membersPagination');
        
        console.log('=== loadMembers called ===', 'page:', page);
        
        if (!membersList) {
            console.error('membersList element not found!');
            return;
        }
        
        // Get admin token
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            console.error('No admin token found!');
            if (noMembersMessage) {
                noMembersMessage.style.display = 'block';
                noMembersMessage.textContent = 'Authentication required. Please log in again.';
            }
            return;
        }
        
        // Show loading state
        membersList.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--text-light);">Loading members...</td></tr>';
        if (paginationDiv) paginationDiv.innerHTML = '';
        
        try {
            // Get search term
            const searchTerm = document.getElementById('memberSearch')?.value || '';
            
            // Get page size from selector
            const pageSizeSelect = document.getElementById('memberPageSize');
            if (pageSizeSelect) {
                membersPerPage = parseInt(pageSizeSelect.value) || 30;
            }
            
            // Build URL with pagination and search
            let url = `/api/admin/directories/members?page=${page}&limit=${membersPerPage}`;
            if (searchTerm) {
                url += `&search=${encodeURIComponent(searchTerm)}`;
            }
            
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    // Token expired or invalid
                    sessionStorage.removeItem('adminToken');
                    sessionStorage.removeItem('adminAuthenticated');
                    window.location.href = 'admin-login.html';
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            const members = data.entries || [];
            const pagination = data.pagination || {};
            
            console.log('Members from API:', members);
            console.log('Pagination info:', pagination);
            
            // Sort members (client-side sorting for current page)
            const sortBy = document.getElementById('memberSort')?.value || 'name';
            members.sort((a, b) => {
                if (sortBy === 'name') {
                    return (a.name || '').localeCompare(b.name || '');
                } else if (sortBy === 'newest') {
                    const dateA = a.added_date ? new Date(a.added_date).getTime() : 0;
                    const dateB = b.added_date ? new Date(b.added_date).getTime() : 0;
                    return dateB - dateA;
                } else if (sortBy === 'oldest') {
                    const dateA = a.added_date ? new Date(a.added_date).getTime() : 0;
                    const dateB = b.added_date ? new Date(b.added_date).getTime() : 0;
                    return dateA - dateB;
                }
                return 0;
            });
            
            if (members.length === 0) {
                membersList.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-light);">${searchTerm ? 'No members match your search.' : 'No members found.'}</td></tr>`;
                if (noMembersMessage) {
                    noMembersMessage.style.display = 'none';
                }
                if (paginationDiv) paginationDiv.innerHTML = '';
                console.log('No members to display');
                return;
            }
            
            if (noMembersMessage) {
                noMembersMessage.style.display = 'none';
            }
            
            // Update current page
            currentMembersPage = pagination.page || page;
            
            // Function to generate social media icon
            function getSocialMediaIcon(platform, url) {
                if (!url) return '';
                
                const icons = {
                    linkedin: { color: '#0077b5', svg: '<path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>' },
                    twitter: { color: '#1DA1F2', svg: '<path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>' },
                    facebook: { color: '#1877F2', svg: '<path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>' },
                    instagram: { color: '#E4405F', svg: '<path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>' },
                    tiktok: { color: '#000000', svg: '<path d="M19.59 6.69a4.83 4.83 0 01-1.4-.13v6.05a7.5 7.5 0 01-7.5 7.5c-4.14 0-7.5-3.36-7.5-7.5s3.36-7.5 7.5-7.5c.81 0 1.59.13 2.32.36v2.46a5.05 5.05 0 00-2.32-.56c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5V3h2.48a4.79 4.79 0 001.4 3.69z"/>' },
                    threads: { color: '#000000', svg: '<path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.568 8.16c-.169 0-.306.137-.306.306v7.068c0 .169.137.306.306.306h.612c.169 0 .306-.137.306-.306V8.466c0-.169-.137-.306-.306-.306h-.612zm-2.142 1.836c-.169 0-.306.137-.306.306v5.232c0 .169.137.306.306.306h.612c.169 0 .306-.137.306-.306v-5.232c0-.169-.137-.306-.306-.306h-.612zm-2.142 1.836c-.169 0-.306.137-.306.306v3.396c0 .169.137.306.306.306h.612c.169 0 .306-.137.306-.306v-3.396c0-.169-.137-.306-.306-.306h-.612zm-2.142 1.836c-.169 0-.306.137-.306.306v1.56c0 .169.137.306.306.306h.612c.169 0 .306-.137.306-.306v-1.56c0-.169-.137-.306-.306-.306h-.612z"/>' },
                    youtube: { color: '#FF0000', svg: '<path d="M23.498 6.186a3.016 3.016 0 00-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 00.502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 002.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 002.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>' },
                    reddit: { color: '#FF4500', svg: '<path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c1.69 0 3.06 1.37 3.06 3.06 0 1.69-1.37 3.06-3.06 3.06-1.69 0-3.06-1.37-3.06-3.06 0-1.69 1.37-3.06 3.06-3.06zm-10.02 0c1.69 0 3.06 1.37 3.06 3.06 0 1.69-1.37 3.06-3.06 3.06-1.69 0-3.06-1.37-3.06-3.06 0-1.69 1.37-3.06 3.06-3.06zm5.01 2.744c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 2c2.21 0 4 1.79 4 4s-1.79 4-4 4-4-1.79-4-4 1.79-4 4-4zm-1.5 3.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5zm3 0c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5z"/>' }
                };
                
                const icon = icons[platform.toLowerCase()];
                if (!icon) return '';
                
                return `<a href="${url}" target="_blank" rel="noopener noreferrer" title="${platform.charAt(0).toUpperCase() + platform.slice(1)}" style="display: inline-block; width: 24px; height: 24px; background: ${icon.color}; border-radius: 4px; text-align: center; line-height: 24px; text-decoration: none; transition: opacity 0.2s;"><svg width="16" height="16" viewBox="0 0 24 24" fill="white" style="vertical-align: middle;">${icon.svg}</svg></a>`;
            }
            
            console.log('Rendering members:', members.length);
            membersList.innerHTML = members.map((member) => {
                const avatar = member.avatar_url || 'https://via.placeholder.com/50x50/cccccc/cccccc';
                const socialLinks = [];
                
                // Add all social media icons if URLs are provided
                if (member.linkedin_url) socialLinks.push(getSocialMediaIcon('linkedin', member.linkedin_url));
                if (member.twitter_url) socialLinks.push(getSocialMediaIcon('twitter', member.twitter_url));
                if (member.facebook_url) socialLinks.push(getSocialMediaIcon('facebook', member.facebook_url));
                if (member.instagram_url) socialLinks.push(getSocialMediaIcon('instagram', member.instagram_url));
                if (member.tiktok_url) socialLinks.push(getSocialMediaIcon('tiktok', member.tiktok_url));
                if (member.threads_url) socialLinks.push(getSocialMediaIcon('threads', member.threads_url));
                if (member.youtube_url) socialLinks.push(getSocialMediaIcon('youtube', member.youtube_url));
                if (member.reddit_url) socialLinks.push(getSocialMediaIcon('reddit', member.reddit_url));
                
                return `
                    <tr style="border-bottom: 1px solid var(--border);" data-member-id="${member.id}">
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;">
                            <img src="${avatar}" alt="Avatar" style="width: 50px; height: 50px; border-radius: 0; object-fit: cover; border: none;">
                        </td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle; font-weight: 600; color: var(--primary);">${member.name || 'No Name'}</td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;">${member.title || 'N/A'}</td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;">${member.organization || 'N/A'}</td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;">
                            ${member.website ? `<a href="${member.website}" target="_blank" rel="noopener noreferrer" style="color: var(--primary); text-decoration: none;">${member.website.replace(/^https?:\/\//, '')}</a>` : 'N/A'}
                        </td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;">
                            ${socialLinks.length > 0 ? `<div style="display: flex; align-items: center; gap: 5px;">${socialLinks.join('')}</div>` : 'N/A'}
                        </td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle; white-space: nowrap;">
                            <div style="display: flex; align-items: center; gap: 5px; justify-content: center;">
                                <button class="btn-small btn-edit" onclick="editMember(${member.id}, '${(member.email || '').replace(/'/g, "\\'")}', '${(member.name || '').replace(/'/g, "\\'")}', '${(member.title || '').replace(/'/g, "\\'")}', '${(member.organization || '').replace(/'/g, "\\'")}', '${(member.website || '').replace(/'/g, "\\'")}', '${(member.linkedin_url || '').replace(/'/g, "\\'")}', '${(member.twitter_url || '').replace(/'/g, "\\'")}', '${(member.avatar_url || '').replace(/'/g, "\\'")}')" style="margin: 0;">Edit</button>
                                <button class="btn-small btn-delete" onclick="deleteMember(${member.id}, '${(member.name || '').replace(/'/g, "\\'")}')" style="margin: 0;">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Add hover effect to rows
            const rows = membersList.querySelectorAll('tr');
            rows.forEach(row => {
                row.style.cursor = 'pointer';
                row.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = 'var(--light)';
                });
                row.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });
            });
            
            // Render pagination
            if (paginationDiv && pagination.pages > 1) {
                let paginationHTML = '<div style="display: flex; align-items: center; gap: 10px;">';
                
                // Previous button
                if (pagination.has_prev) {
                    paginationHTML += `<button class="btn-small btn-edit" onclick="loadMembers(${currentMembersPage - 1})" style="padding: 8px 15px;">Previous</button>`;
                } else {
                    paginationHTML += `<button class="btn-small" disabled style="padding: 8px 15px; opacity: 0.5; cursor: not-allowed;">Previous</button>`;
                }
                
                // Page info
                paginationHTML += `<span style="padding: 0 15px;">Page ${pagination.page} of ${pagination.pages} (${pagination.total} total)</span>`;
                
                // Next button
                if (pagination.has_next) {
                    paginationHTML += `<button class="btn-small btn-edit" onclick="loadMembers(${currentMembersPage + 1})" style="padding: 8px 15px;">Next</button>`;
                } else {
                    paginationHTML += `<button class="btn-small" disabled style="padding: 8px 15px; opacity: 0.5; cursor: not-allowed;">Next</button>`;
                }
                
                paginationHTML += '</div>';
                paginationDiv.innerHTML = paginationHTML;
            } else if (paginationDiv) {
                paginationDiv.innerHTML = '';
            }
            
            console.log('Members rendered successfully. Total displayed:', members.length);
        } catch (error) {
            console.error('Error loading members:', error);
            membersList.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--live);">Error loading members. Please try again.</td></tr>';
            if (noMembersMessage) {
                noMembersMessage.style.display = 'none';
            }
            if (paginationDiv) paginationDiv.innerHTML = '';
        }
    }
    
    function changeMemberPageSize() {
        const pageSizeSelect = document.getElementById('memberPageSize');
        if (pageSizeSelect) {
            membersPerPage = parseInt(pageSizeSelect.value) || 30;
        }
        loadMembers(1); // Reset to page 1
    }
    
    function filterMembers() {
        // Reset to page 1 when searching
        loadMembers(1);
    }
    
    function sortMembers() {
        // Reload current page with new sort
        loadMembers(currentMembersPage);
    }
    
    function refreshMembers() {
        // Reset search and reload page 1
        const searchInput = document.getElementById('memberSearch');
        if (searchInput) {
            searchInput.value = '';
        }
        loadMembers(1);
    }
    
    
    async function editMember(memberId, email, name, title, organization, website, linkedinUrl, twitterUrl, avatarUrl) {
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Authentication required. Please log in again.');
            window.location.href = 'admin-login.html';
            return;
        }

        try {
            // Always fetch full member details from API to get all social media fields
            const response = await fetch(`/api/admin/directories/members?limit=1000`, {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to fetch member details');
            }

            const data = await response.json();
            const member = data.entries?.find(m => m.id === parseInt(memberId));
            
            if (!member) {
                alert('Member not found!');
                return;
            }
            
            // Redirect to directories section with members tab
            showSection('directories', null);
            setTimeout(() => {
                showDirectoryTab('members');
                setTimeout(() => {
                    currentDirectoryType = 'members';
                    currentDirectoryId = memberId.toString();
                    showDirectoryForm('members', memberId);
                }, 200);
            }, 100);
        } catch (error) {
            console.error('Error fetching member:', error);
            alert('Error loading member details. Please try again.');
        }
    }
    
    async function deleteMember(memberId, memberName) {
        const confirmMessage = memberName 
            ? `Are you sure you want to delete member "${memberName}"? This action cannot be undone.`
            : 'Are you sure you want to delete this member? This action cannot be undone.';
        
        if (!confirm(confirmMessage)) {
            return;
        }

        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Authentication required. Please log in again.');
            window.location.href = 'admin-login.html';
            return;
        }

        try {
            const response = await fetch(`/api/admin/directories/members/${memberId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to delete member');
            }

            loadMembers();
            updateOverviewStats(); // Update stats after member deletion
            alert('Member deleted successfully!');
        } catch (error) {
            console.error('Error deleting member:', error);
            alert('Error deleting member: ' + error.message);
        }
    }

    // ========== REGISTERED BUSINESSES MANAGEMENT ==========
    let currentBusinessesPage = 1;
    let businessesPerPage = 100;
    
    async function loadBusinesses(page = 1) {
        const businessesList = document.getElementById('businessesList');
        const noBusinessesMessage = document.getElementById('noBusinessesMessage');
        const paginationDiv = document.getElementById('businessesPagination');
        
        console.log('=== loadBusinesses called ===', 'page:', page);
        
        if (!businessesList) {
            console.error('businessesList element not found!');
            return;
        }
        
        // Get page size from selector
        const pageSizeSelect = document.getElementById('businessPageSize');
        if (pageSizeSelect) {
            businessesPerPage = parseInt(pageSizeSelect.value) || 100;
        }
        
        // Get admin token
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            console.error('No admin token found!');
            if (noBusinessesMessage) {
                noBusinessesMessage.style.display = 'block';
                noBusinessesMessage.textContent = 'Authentication required. Please log in again.';
            }
            return;
        }
        
        // Show loading state
        businessesList.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--text-light);">Loading businesses...</td></tr>';
        if (paginationDiv) paginationDiv.innerHTML = '';
        
        try {
            // Get filters
            const statusFilter = document.getElementById('businessFilter')?.value || 'all';
            
            // Build URL with pagination and status filter
            let url = `/api/admin/businesses?page=${page}&limit=${businessesPerPage}`;
            if (statusFilter !== 'all') {
                url += `&status=${encodeURIComponent(statusFilter === 'pending' ? 'Pending Review' : statusFilter === 'verified' ? 'Verified Business' : statusFilter === 'approved' ? 'Approved' : 'Rejected')}`;
            }
            
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    sessionStorage.removeItem('adminToken');
                    sessionStorage.removeItem('adminAuthenticated');
                    window.location.href = 'admin-login.html';
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            const businesses = data.businesses || [];
            const pagination = data.pagination || {};
            
            console.log('Businesses from API:', businesses);
            console.log('Pagination info:', pagination);
            
            // Get search term for filtering (client-side for current page)
            const searchTerm = document.getElementById('businessSearch')?.value.toLowerCase() || '';
            let filteredBusinesses = businesses;
            if (searchTerm) {
                filteredBusinesses = businesses.filter(business => {
                    const name = (business.business_name || '').toLowerCase();
                    const owner = (business.owner_name || '').toLowerCase();
                    return name.includes(searchTerm) || owner.includes(searchTerm);
                });
            }
            
            // Sort businesses
            const sortBy = document.getElementById('businessSort')?.value || 'newest';
            filteredBusinesses.sort((a, b) => {
                if (sortBy === 'newest') {
                    const dateA = a.registered_date ? new Date(a.registered_date).getTime() : 0;
                    const dateB = b.registered_date ? new Date(b.registered_date).getTime() : 0;
                    return dateB - dateA;
                } else if (sortBy === 'oldest') {
                    const dateA = a.registered_date ? new Date(a.registered_date).getTime() : 0;
                    const dateB = b.registered_date ? new Date(b.registered_date).getTime() : 0;
                    return dateA - dateB;
                } else if (sortBy === 'name') {
                    return (a.business_name || '').localeCompare(b.business_name || '');
                }
                return 0;
            });
            
            if (filteredBusinesses.length === 0) {
                businessesList.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-light);">${searchTerm || statusFilter !== 'all' ? 'No businesses match your filters.' : 'No registered businesses found.'}</td></tr>`;
                if (noBusinessesMessage) noBusinessesMessage.style.display = 'none';
                if (paginationDiv) paginationDiv.innerHTML = '';
                return;
            }
            
            if (noBusinessesMessage) noBusinessesMessage.style.display = 'none';
            
            // Update current page
            currentBusinessesPage = pagination.page || page;
            
            // Render businesses in table format
            businessesList.innerHTML = filteredBusinesses.map(business => {
                let regDate = 'N/A';
                if (business.registered_date) {
                    try {
                        regDate = new Date(business.registered_date).toLocaleDateString();
                    } catch (e) {
                        regDate = business.registered_date;
                    }
                }
                const statusColor = business.status === 'Approved' || business.status === 'Verified Business' ? 'var(--success)' : 
                                   business.status === 'Pending Review' ? '#fbbf24' : 'var(--live)';
                
                return `
                    <tr style="border-bottom: 1px solid var(--border);" data-business-id="${business.id}">
                        <td style="padding: 10px 8px; border: none; vertical-align: middle; font-weight: 600; color: var(--primary);">${business.business_name || 'No Name'}</td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;">${business.owner_name || 'Not specified'}</td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;">${business.owner_email || 'Not specified'}</td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;">${business.phone || 'Not provided'}</td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;">${regDate}</td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle;"><span style="color: ${statusColor};">${business.status || 'Unknown'}</span></td>
                        <td style="padding: 10px 8px; border: none; vertical-align: middle; white-space: nowrap;">
                            <div style="display: flex; align-items: center; gap: 5px; justify-content: center; flex-wrap: nowrap;">
                                <button class="btn-small" style="background: var(--success); color: white; border: none; margin: 0; padding: 6px 12px; font-size: 0.85rem; white-space: nowrap;" onclick="approveBusiness('${business.id}')">Approve</button>
                                <button class="btn-small btn-edit" onclick="viewBusinessDetails('${business.id}')" style="margin: 0; padding: 6px 12px; font-size: 0.85rem; white-space: nowrap;">View</button>
                                <button class="btn-small btn-delete" onclick="rejectBusiness('${business.id}')" style="margin: 0; padding: 6px 12px; font-size: 0.85rem; white-space: nowrap;">Reject</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Add hover effect
            const rows = businessesList.querySelectorAll('tr');
            rows.forEach(row => {
                row.style.cursor = 'pointer';
                row.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = 'var(--light)';
                });
                row.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });
            });
            
            // Render pagination
            if (paginationDiv && pagination.pages > 1) {
                let paginationHTML = '<div style="display: flex; align-items: center; gap: 10px;">';
                if (pagination.has_prev) {
                    paginationHTML += `<button class="btn-small btn-edit" onclick="loadBusinesses(${currentBusinessesPage - 1})" style="padding: 8px 15px;">Previous</button>`;
                } else {
                    paginationHTML += `<button class="btn-small" disabled style="padding: 8px 15px; opacity: 0.5; cursor: not-allowed;">Previous</button>`;
                }
                paginationHTML += `<span style="padding: 0 15px;">Page ${pagination.page} of ${pagination.pages} (${pagination.total} total)</span>`;
                if (pagination.has_next) {
                    paginationHTML += `<button class="btn-small btn-edit" onclick="loadBusinesses(${currentBusinessesPage + 1})" style="padding: 8px 15px;">Next</button>`;
                } else {
                    paginationHTML += `<button class="btn-small" disabled style="padding: 8px 15px; opacity: 0.5; cursor: not-allowed;">Next</button>`;
                }
                paginationHTML += '</div>';
                paginationDiv.innerHTML = paginationHTML;
            } else if (paginationDiv) {
                paginationDiv.innerHTML = '';
            }
            
            console.log('Businesses rendered successfully. Total displayed:', filteredBusinesses.length);
        } catch (error) {
            console.error('Error loading businesses:', error);
            businessesList.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--live);">Error loading businesses. Please try again.</td></tr>';
            if (noBusinessesMessage) noBusinessesMessage.style.display = 'none';
            if (paginationDiv) paginationDiv.innerHTML = '';
        }
    }
    
    function getStatusBadge(status) {
        const badges = {
            'Pending Review': '<span style="background: #fbbf24; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem;">Pending Review</span>',
            'Verified Business': '<span style="background: var(--success); color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem;">‚úì Verified Business</span>',
            'Approved': '<span style="background: var(--success); color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem;">‚úì Approved</span>',
            'Rejected': '<span style="background: var(--live); color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem;">Rejected</span>'
        };
        return badges[status] || `<span style="background: var(--text-light); color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem;">${status || 'Unknown'}</span>`;
    }
    
    function changeBusinessPageSize() {
        const pageSizeSelect = document.getElementById('businessPageSize');
        if (pageSizeSelect) {
            businessesPerPage = parseInt(pageSizeSelect.value) || 100;
        }
        loadBusinesses(1); // Reset to page 1
    }
    
    function filterBusinesses() {
        loadBusinesses(1); // Reset to page 1 when filtering
    }
    
    function sortBusinesses() {
        loadBusinesses(currentBusinessesPage); // Keep current page
    }
    
    function refreshBusinesses() {
        const searchInput = document.getElementById('businessSearch');
        if (searchInput) {
            searchInput.value = '';
        }
        loadBusinesses(1);
    }
    
    async function viewBusinessDetails(businessId) {
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Please log in to view business details.');
            return;
        }
        
        try {
            // Fetch business from API
            const response = await fetch(`/api/admin/businesses?limit=1000`, {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to load businesses');
            }
            
            const data = await response.json();
            const businesses = data.businesses || [];
            const business = businesses.find(b => b.id == businessId);
            
            if (!business) {
                alert('Business not found!');
                return;
            }
            
            const details = `
Business Name: ${business.business_name || 'Not specified'}
Owner: ${business.owner_name || 'Not specified'}
Owner Email: ${business.owner_email || 'Not specified'}
Relationship: ${business.owner_relationship || 'Not specified'}
Sector: ${business.business_sector || 'Not specified'}
Address: ${business.business_address || 'Not specified'}
Year of Formation: ${business.year_of_formation || 'Not specified'}
Number of Employees: ${business.number_of_employees || 'Not specified'}
CAC Registered: ${business.cac_registered ? 'Yes' : 'No'}
Has Business Bank Account: ${business.has_business_bank_account ? 'Yes' : 'No'}
${business.bank_name ? `Bank Name: ${business.bank_name}` : ''}
${business.account_number ? `Account Number: ${business.account_number}` : ''}
${business.account_name ? `Account Name: ${business.account_name}` : ''}
Status: ${business.status || 'Pending Review'}
Registered Date: ${business.registered_date || 'Not specified'}
        `;
        
        alert(details);
        } catch (error) {
            console.error('Error loading business details:', error);
            alert('Error loading business details: ' + error.message);
        }
    }
    
    function approveBusiness(businessId) {
        if (!confirm('Are you sure you want to approve this business?')) {
            return;
        }
        
        const businesses = JSON.parse(localStorage.getItem('registeredBusinesses') || '{}');
        let updated = false;
        
        Object.keys(businesses).forEach(email => {
            const userBusinesses = businesses[email] || [];
            const business = userBusinesses.find(b => b.id === businessId);
            if (business) {
                business.status = 'Approved';
                updated = true;
            }
        });
        
        if (updated) {
            localStorage.setItem('registeredBusinesses', JSON.stringify(businesses));
            loadBusinesses();
            updateOverviewStats(); // Update stats after business approval
            alert('Business approved successfully!');
        } else {
            alert('Business not found!');
        }
    }
    
    async function rejectBusiness(businessId) {
        const reason = prompt('Please provide a reason for rejection (optional):');
        if (reason === null) return; // User cancelled
        
        if (!confirm('Are you sure you want to reject this business?')) {
            return;
        }
        
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Please log in to reject businesses.');
            return;
        }
        
        try {
            const response = await fetch(`/api/admin/businesses/${businessId}/reject`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reason: reason || null })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || 'Failed to reject business');
            }
            
            await loadBusinesses();
            updateOverviewStats(); // Update stats after business rejection
            alert('Business rejected successfully!');
        } catch (error) {
            console.error('Error rejecting business:', error);
            alert('Error rejecting business: ' + error.message);
        }
    }
    
    function viewCACCertificate(businessId) {
        const businesses = JSON.parse(localStorage.getItem('registeredBusinesses') || '{}');
        let certificate = null;
        
        Object.keys(businesses).forEach(email => {
            const userBusinesses = businesses[email] || [];
            const business = userBusinesses.find(b => b.id === businessId);
            if (business && business.cacCertificate) {
                certificate = business.cacCertificate;
            }
        });
        
        if (!certificate) {
            alert('No CAC certificate found for this business.');
            return;
        }
        
        // Open certificate in new window
        const newWindow = window.open();
        newWindow.document.write(`
            <html>
                <head><title>CAC Certificate</title></head>
                <body style="margin: 0; padding: 20px; text-align: center;">
                    <h2>CAC Certificate</h2>
                    <img src="${certificate}" style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 8px;">
                    <p style="margin-top: 20px;"><button onclick="window.close()">Close</button></p>
                </body>
            </html>
        `);
    }
    
    async function verifyCACCertificate(businessId) {
        if (!confirm('Have you verified the CAC certificate is valid? This will mark the business as "Verified Business".')) {
            return;
        }
        
        const adminToken = sessionStorage.getItem('adminToken');
        if (!adminToken) {
            alert('Please log in to verify CAC certificates.');
            return;
        }
        
        try {
            const response = await fetch(`/api/admin/businesses/${businessId}/verify`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || 'Failed to verify business');
            }
            
            await loadBusinesses();
            updateOverviewStats(); // Update stats after business verification
            alert('CAC certificate verified! Business marked as "Verified Business".');
        } catch (error) {
            console.error('Error verifying CAC certificate:', error);
            alert('Error verifying CAC certificate: ' + error.message);
        }
    }
    
    // Debug function to check API data (updated to use API instead of localStorage)
    window.debugAdminData = async function() {
        console.log('=== ADMIN DASHBOARD DEBUG ===');
        const adminToken = sessionStorage.getItem('adminToken');
        
        if (!adminToken) {
            console.error('No admin token found. Please log in.');
            return { error: 'Not authenticated' };
        }
        
        try {
            // Fetch users from API
            const usersResponse = await fetch('/api/admin/users?page=1&limit=1000', {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            const usersData = await usersResponse.json();
            const users = usersData.users || [];
            
            // Fetch businesses from API
            const businessesResponse = await fetch('/api/admin/businesses?page=1&limit=1000', {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            const businessesData = await businessesResponse.json();
            const businesses = businessesData.businesses || [];
            
            console.log('Registered Users:', users);
            console.log('Number of users:', users.length);
            console.log('User emails:', users.map(u => u.email));
            
            // Log each user's details
            users.forEach(user => {
                console.log(`User: ${user.email}`, user);
            });
            
            console.log('Registered Businesses:', businesses);
            console.log('Total businesses:', businesses.length);
            console.log('Business owners:', [...new Set(businesses.map(b => b.owner_email || b.user_email))]);
            
            // Force reload users
            console.log('Forcing reload of users...');
            loadUsers();
            
            return {
                users: users,
                businesses: businesses,
                userCount: users.length,
                businessCount: businesses.length
            };
        } catch (error) {
            console.error('Error fetching debug data:', error);
            return { error: error.message };
        }
    };
    
    // Initialize overview stats on page load
    window.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, calling updateOverviewStats...');
        // Wait a bit for all elements to be ready
        setTimeout(() => {
            updateOverviewStats();
        }, 100);
    });
    
    // showSection is already defined above and handles overview stats refresh
    
    // =====================================================
    // NEWSLETTER SUBSCRIBERS FUNCTIONS
    // =====================================================
    
    let newsletterCurrentPage = 1;
    let newsletterPageSize = 50;
    let newsletterStatusFilter = 'all';
    let allNewsletterSubscribers = [];
    
    async function loadNewsletterSubscribers(page = 1) {
        try {
            const adminToken = sessionStorage.getItem('adminToken');
            if (!adminToken) {
                console.error('No admin token found');
                return;
            }
            
            const status = newsletterStatusFilter === 'all' ? 'all' : newsletterStatusFilter;
            const response = await fetch(`/api/admin/newsletter/subscribers?page=${page}&limit=${newsletterPageSize}&status=${status}`, {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    sessionStorage.removeItem('adminToken');
                    sessionStorage.removeItem('adminAuthenticated');
                    window.location.href = 'admin-login.html';
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            allNewsletterSubscribers = data.subscribers || [];
            newsletterCurrentPage = page;
            
            displayNewsletterSubscribers();
            updateNewsletterPagination(data.pagination);
            updateNewsletterCounts(data.subscribers || []);
        } catch (error) {
            console.error('Error loading newsletter subscribers:', error);
            document.getElementById('newsletterList').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--text-light);">Error loading subscribers. Please try again.</td></tr>';
        }
    }
    
    function displayNewsletterSubscribers() {
        const container = document.getElementById('newsletterList');
        const noMessage = document.getElementById('noNewsletterMessage');
        
        if (!container) return;
        
        // Filter by search term if provided
        const searchTerm = document.getElementById('newsletterSearch')?.value.toLowerCase() || '';
        let filtered = allNewsletterSubscribers;
        
        if (searchTerm) {
            filtered = allNewsletterSubscribers.filter(sub => 
                sub.email.toLowerCase().includes(searchTerm)
            );
        }
        
        if (filtered.length === 0) {
            container.innerHTML = '';
            if (noMessage) noMessage.style.display = 'block';
            return;
        }
        
        if (noMessage) noMessage.style.display = 'none';
        
        container.innerHTML = filtered.map(subscriber => {
            const subscribedDate = subscriber.subscribed_at 
                ? new Date(subscriber.subscribed_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
                : 'N/A';
            const statusBadge = subscriber.is_active 
                ? '<span style="background: #48bb78; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Active</span>'
                : '<span style="background: #a0aec0; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">Inactive</span>';
            
            return `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px 8px;">${subscriber.email || 'N/A'}</td>
                    <td style="padding: 12px 8px;">${subscribedDate}</td>
                    <td style="padding: 12px 8px;">${subscriber.source || 'homepage'}</td>
                    <td style="padding: 12px 8px; text-align: center;">${statusBadge}</td>
                    <td style="padding: 12px 8px; text-align: center;">
                        ${subscriber.is_active 
                            ? `<button onclick="unsubscribeNewsletter('${subscriber.email}')" class="btn-small" style="background: #fc8181; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Unsubscribe</button>`
                            : `<button onclick="resubscribeNewsletter('${subscriber.email}')" class="btn-small" style="background: #48bb78; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Resubscribe</button>`
                        }
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function updateNewsletterPagination(pagination) {
        const container = document.getElementById('newsletterPagination');
        if (!container || !pagination) return;
        
        if (pagination.pages <= 1) {
            container.innerHTML = '';
            return;
        }
        
        let html = '';
        
        // Previous button
        if (pagination.has_prev) {
            html += `<button onclick="loadNewsletterSubscribers(${pagination.page - 1})" class="btn-small" style="padding: 8px 15px;">Previous</button>`;
        }
        
        // Page numbers
        html += `<span style="padding: 0 15px;">Page ${pagination.page} of ${pagination.pages}</span>`;
        
        // Next button
        if (pagination.has_next) {
            html += `<button onclick="loadNewsletterSubscribers(${pagination.page + 1})" class="btn-small" style="padding: 8px 15px;">Next</button>`;
        }
        
        container.innerHTML = html;
    }
    
    function updateNewsletterCounts(subscribers) {
        const total = subscribers.length;
        const active = subscribers.filter(s => s.is_active).length;
        const inactive = total - active;
        
        const totalEl = document.getElementById('newsletterTotalCount');
        const activeEl = document.getElementById('newsletterActiveCount');
        const inactiveEl = document.getElementById('newsletterInactiveCount');
        
        if (totalEl) totalEl.textContent = total;
        if (activeEl) activeEl.textContent = active;
        if (inactiveEl) inactiveEl.textContent = inactive;
    }
    
    function filterNewsletterSubscribers() {
        const status = document.getElementById('newsletterStatus')?.value || 'all';
        newsletterStatusFilter = status;
        loadNewsletterSubscribers(1);
    }
    
    function changeNewsletterPageSize() {
        const size = parseInt(document.getElementById('newsletterPageSize')?.value || '50', 10);
        newsletterPageSize = size;
        loadNewsletterSubscribers(1);
    }
    
    function refreshNewsletterSubscribers() {
        loadNewsletterSubscribers(newsletterCurrentPage);
    }
    
    async function unsubscribeNewsletter(email) {
        if (!confirm(`Are you sure you want to unsubscribe ${email}?`)) {
            return;
        }
        
        try {
            const adminToken = sessionStorage.getItem('adminToken');
            if (!adminToken) return;
            
            // Update in database
            const response = await fetch(`/api/admin/newsletter/subscribers/${encodeURIComponent(email)}/unsubscribe`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                alert('Subscriber unsubscribed successfully!');
                refreshNewsletterSubscribers();
            } else {
                alert('Failed to unsubscribe. Please try again.');
            }
        } catch (error) {
            console.error('Error unsubscribing:', error);
            alert('Error unsubscribing. Please try again.');
        }
    }
    
    async function resubscribeNewsletter(email) {
        if (!confirm(`Are you sure you want to resubscribe ${email}?`)) {
            return;
        }
        
        try {
            const adminToken = sessionStorage.getItem('adminToken');
            if (!adminToken) return;
            
            // Update in database
            const response = await fetch(`/api/admin/newsletter/subscribers/${encodeURIComponent(email)}/resubscribe`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                alert('Subscriber resubscribed successfully!');
                refreshNewsletterSubscribers();
            } else {
                alert('Failed to resubscribe. Please try again.');
            }
        } catch (error) {
            console.error('Error resubscribing:', error);
            alert('Error resubscribing. Please try again.');
        }
    }
    
</script>

</body>
</html>

